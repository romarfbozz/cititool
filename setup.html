<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Programme + Setup</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    /* мелкие локальные вещи, остальное — из /ui */
    .slot-tnum{display:grid;grid-template-columns:72px 56px 1fr auto;gap:.6rem;align-items:center}
    .tnum-btn.badge{min-width:64px}
    .thumb-ph{width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700}
    .errbar{position:fixed;left:8px;right:8px;top:8px;z-index:9999;background:#fff3f3;border:1px solid #f3c2c2;color:#7a1e1e;border-radius:12px;padding:10px;box-shadow:0 6px 24px rgba(0,0,0,.12);font-size:14px}
    .program-hero{display:grid;place-items:center;margin:.25rem 0 .75rem}
    .program-hero .ph{width:100%;max-width:680px;aspect-ratio:4/3;background:#eef3ff;border-radius:14px;display:grid;place-items:center;color:#9cb1d9;font-weight:800}
    .program-hero img{max-width:92vw;max-height:30vh;border-radius:14px}
    /* выравниваем логотип-бейдж */
    .appbar .logo .badge{width:28px;height:28px;border-radius:9px;object-fit:cover;display:block}
  </style>
</head>
<body data-active="programme">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit">
        <div class="title">CitiTool</div>
        <div class="subtitle">Programme + Setup</div>
      </div>
    </a>
    <div class="actions" style="display:flex;gap:.4rem;align-items:center">
      <button class="btn brand sm" id="btnNewTop">Neues Programm</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
        <svg><use href="./ui/icons.svg#search"/></svg>
      </button>
    </div>
  </div>
</header>
<div class="searchbar collapsed">
  <input class="field" type="search" placeholder="Im Setup suchen…" id="setupSearch">
</div>

<main class="container">
  <!-- МОДУЛЬ 1: ПРОГРАММЫ -->
  <section class="section">
    <h2>Programme</h2>

    <!-- КРУПНОЕ ПРЕВЬЮ СВЕРХУ -->
    <div id="progHero" class="program-hero">
      <div class="ph">no foto</div>
    </div>

    <div class="row between">
      <div class="row">
        <!-- Заголовок: Название — #номер (кликабельно для редактирования) -->
        <div class="select-like" id="progTitle">Programm wählen…</div>
      </div>
      <div class="row">
        <button class="btn sm" id="btnChoose">Wechseln</button>
        <button class="btn ok sm" id="applyLive">In Live anwenden</button>
      </div>
    </div>
  </section>

  <!-- МОДУЛЬ 2: LIVE SETUP -->
  <section class="section">
    <h2>Setup (Live)</h2>
    <div class="tabs">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
    </div>
    <div id="slots" class="slots"></div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<!-- мягкий ловец ошибок -->
<script>
(function(){
  function showErr(msg){ var el=document.createElement('div'); el.className='errbar'; el.textContent=msg; document.body.appendChild(el); }
  window.addEventListener('error', e=> showErr('Fehler: '+e.message));
  window.addEventListener('unhandledrejection', e=> showErr('Promise: '+(e.reason&&e.reason.message||e.reason)));
})();
</script>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
(function(){
  if (typeof window.CT === 'undefined') {
    const el=document.createElement('div'); el.className='errbar';
    el.textContent='Fehler: core.js nicht geladen. Prüfe Pfad ./ui/core.js';
    document.body.appendChild(el); return;
  }

  CT.ready(function(){
    CT.ensureSeeds();
    const K = CT.CT_KEYS || window.CT_KEYS;
    const pad2 = n=>String(n).padStart(2,'0');
    const defT = i=>`T${pad2(i+1)}${pad2(i+1)}`;

    // ---------- Programme ----------
    const Prog = (function(){
      let progs = CT.storage.read(K.PROGS, []);
      let currentId = progs[0]?.id || null;

      const $title = document.getElementById('progTitle');
      const $hero  = document.getElementById('progHero');

      const cur = ()=> progs.find(p=>p.id===currentId)||null;
      const reload = ()=> progs = CT.storage.read(K.PROGS, []);

      function render(){
        reload();
        const p = cur();
        if(!p){
          $title.textContent='Programm wählen…';
          $hero.innerHTML = '<div class="ph">no foto</div>';
          return;
        }
        // Название — #номер
        $title.textContent = `${p.title || 'Programm'} — #${p.number || '—'}`;
        $hero.innerHTML    = p.drawingData
          ? `<img src="${p.drawingData}" alt="Zeichnung">`
          : '<div class="ph">no foto</div>';
      }

      function choose(){
        reload();
        if(!progs.length){ CT.toast('Keine Programme','err'); return; }
        const items = progs.map(p=>({id:p.id, title:`#${p.number} — ${p.title}`, meta:new Date(p.date).toLocaleDateString()}));
        CT.openDrawer({title:'Programme', items, onSelect:(id)=>{
          // Выбрали программу -> сразу применяем в Live
          currentId=id;
          const p = progs.find(x=>x.id===id);
          if(p){
            const live = { ro:(p.ro||Array(12).fill(null)), ru:(p.ru||Array(12).fill(null)) };
            CT.storage.write(K.SETUP, live);
            CT.toast('Programm angewendet','ok');
          }
          CT.closeDrawer(); render(); Live.render();
        }});
      }

      function editor(isNew){
        const p = isNew
          ? { id:CT.uid(), number:1000+Math.floor(Math.random()*9000), title:'Neues Programm', date:Date.now(),
              ro:Array(12).fill(null), ru:Array(12).fill(null), drawingName:'', drawingData:'' }
          : (cur() || null);
        if(!p){ CT.toast('Kein Programm','err'); return; }

        const html = `
          ${p.drawingData?`<div class="imgwrap"><img src="${p.drawingData}" alt=""></div>`:
            `<div class="imgwrap"><div style="width:100%;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`}
          <div class="row">
            <label class="btn sm" for="pr_file" style="cursor:pointer">Zeichnung anhängen</label>
            ${p.drawingData?'<button class="btn sm warn" id="btnRemove">Entfernen</button>':''}
          </div>
          <input id="pr_file" type="file" accept="image/*,application/pdf" style="display:none">
          <div class="muted" id="fileInfo">${p.drawingName?CT.escape('Angehängt: '+p.drawingName):'Keine Zeichnung'}</div>
          <label class="fld" style="margin-top:.5rem">Titel<input id="pr_t" value="${CT.escape(p.title||'')}"></label>
          <label class="fld">Nummer<input id="pr_n" inputmode="numeric" pattern="[0-9]*" value="${CT.escape(p.number||'')}"></label>
          ${!isNew?'<div class="row mt"><button class="btn warn" id="doDelete">Löschen</button></div>':''}
        `;

        CT.openModal({title:isNew?'Neues Programm':'Programm', html, okText:'Speichern', cancelText:'Schließen', onOk: async ()=>{
          const up = {...p};
          up.title  = (document.getElementById('pr_t').value||'').trim() || 'Programm';
          up.number = (document.getElementById('pr_n').value||'').trim() || up.number || 1000;

          const f = document.getElementById('pr_file')?.files?.[0];
          const removed = document.getElementById('btnRemove')?.dataset.rm === '1';
          if(f){ up.drawingName=f.name; up.drawingData=await CT.readFileAsDataURL(f); }
          else if(removed){ up.drawingName=''; up.drawingData=''; }

          if(isNew) progs.push(up); else progs = progs.map(x=>x.id===up.id?up:x);
          CT.storage.write(K.PROGS, progs);
          currentId = up.id;
          render(); CT.toast('Gespeichert','ok');
        }});

        setTimeout(()=>{
          const f=document.getElementById('pr_file');
          if(f) f.onchange=()=>{ const i=document.getElementById('fileInfo'); const ff=f.files?.[0]; if(i&&ff) i.textContent='Ausgewählt: '+ff.name; };
          const rm=document.getElementById('btnRemove'); if(rm) rm.onclick=()=>{ rm.dataset.rm='1'; const i=document.getElementById('fileInfo'); if(i) i.textContent='Keine Zeichnung'; };
          const del=document.getElementById('doDelete'); if(del) del.onclick=()=>{ progs=progs.filter(x=>x.id!==p.id); CT.storage.write(K.PROGS,progs); currentId=progs[0]?.id||null; CT.closeModal(); render(); Live.render(); CT.toast('Gelöscht','ok'); };
          document.getElementById('pr_t')?.focus();
        },0);
      }

      function applyToLive(){
        const p = cur(); if(!p) return;
        const live = { ro:(p.ro||Array(12).fill(null)), ru:(p.ru||Array(12).fill(null)) };
        CT.storage.write(K.SETUP, live); CT.toast('In Live angewendet','ok'); Live.render();
      }

      return {
        render, choose, new:()=>editor(true), edit:()=>editor(false), applyToLive
      };
    })();

    // ---------- Live Setup ----------
    const Live = (function(){
      let side='ro';
      const $slots=document.getElementById('slots');

      function render(){
        let live=CT.storage.read(K.SETUP,{ro:Array(12).fill(null),ru:Array(12).fill(null)});
        const tools=CT.storage.read(K.TOOLS,[]);
        const q=(document.getElementById('setupSearch')?.value||'').toLowerCase();
        $slots.innerHTML='';
        for(let i=0;i<12;i++){
          const v=live[side][i]; const tnum=v?.tnum||defT(i);
          const el=document.createElement('div'); el.className='slot';
          if(!v){
            el.innerHTML=`
            <div class="slot-full slot-tnum">
              <span class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</span>
              <div class="thumb-ph">no foto</div>
              <div class="meta"><div class="name"><b>#${i+1} • Leer</b></div><div class="sub">—</div></div>
              <div class="tail"><button class="btn sm" data-add="${i}">Hinzufügen</button></div>
            </div>`;
          } else {
            const t=tools.find(x=>x.id===v.toolId);
            const name=t?t.name:'—', code=t?t.code:'';
            if(q && !(name.toLowerCase().includes(q)||code.toLowerCase().includes(q))) { continue; }
            const thumb=t?.imgData?`<img src="${t.imgData}" style="width:56px;height:56px;object-fit:cover;border-radius:10px">`:`<div class="thumb-ph">no foto</div>`;
            el.innerHTML=`
            <div class="slot-full slot-tnum">
              <span class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</span>
              ${thumb}
              <div class="meta"><div class="name"><b>${CT.escape(name)}</b></div><div class="sub">${CT.escape(code)}</div></div>
              <div class="tail" style="display:flex;gap:.25rem">
                <button class="icon-btn info" data-info="${i}"><svg><use href="./ui/icons.svg#info"/></svg></button>
                <button class="icon-btn" data-change="${i}"><svg><use href="./ui/icons.svg#edit"/></svg></button>
              </div>
            </div>`;
          }
          $slots.appendChild(el);
        }
        $slots.querySelectorAll('[data-add]').forEach(b=>b.onclick=()=>select(+b.dataset.add));
        $slots.querySelectorAll('[data-change]').forEach(b=>b.onclick=()=>select(+b.dataset.change,true));
        $slots.querySelectorAll('[data-info]').forEach(b=>b.onclick=()=>info(+b.dataset.info));
        $slots.querySelectorAll('[data-tnum]').forEach(b=>b.onclick=()=>tnum(+b.dataset.tnum));
      }

      function select(idx,cycle=false){
        const tools=CT.storage.read(K.TOOLS,[]);
        if(!tools.length){CT.toast('Keine Werkzeuge','err');return;}
        const live=CT.storage.read(K.SETUP,{ro:Array(12).fill(null),ru:Array(12).fill(null)});

        if(cycle){
          const cur=live[side][idx]?.toolId;
          const i=tools.findIndex(t=>t.id===cur);
          const next=(i>=0&&i<tools.length-1)?i+1:0;
          const prev=live[side][idx]||{};
          live[side][idx]={toolId:tools[next].id, tnum:(prev.tnum||defT(idx))};
          CT.storage.write(K.SETUP,live); render(); return;
        }
        const items=tools.map(t=>({id:t.id,title:t.name,meta:t.code}));
        CT.openDrawer({title:`Werkzeug wählen (#${idx+1})`,items,onSelect:id=>{
          const prev=live[side][idx]||{};
          live[side][idx]={toolId:id, tnum:(prev.tnum||defT(idx))};
          CT.storage.write(K.SETUP,live); CT.closeDrawer(); CT.toast('Aktualisiert','ok'); render();
        }});
      }

      function info(i){
        const live=CT.storage.read(K.SETUP,{ro:Array(12).fill(null),ru:Array(12).fill(null)});
        const v=live[side][i]; if(!v){CT.toast('Kein Werkzeug','err');return;}
        const t=CT.getToolFromSlot(live,side,i); if(!t){CT.toast('Kein Werkzeug','err');return;}
        const big=t.imgData?`<div class="imgwrap"><img src="${t.imgData}" alt=""></div>`:`<div class="imgwrap"><div style="width:100%;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`;
        const html=`${big}<b>${CT.escape(t.name)}</b><div class="i-row">${CT.escape(t.code)}</div><div class="row"><button class="btn warn" id="btnRem">Entfernen</button></div>`;
        CT.openModal({title:`Position #${i+1}`,html,cancelText:'Schließen'});
        setTimeout(()=>{ const r=document.getElementById('btnRem'); if(r) r.onclick=()=>{ live[side][i]=null; CT.storage.write(K.SETUP,live); CT.closeModal(); render(); }; },0);
      }

      function tnum(i){
        const live=CT.storage.read(K.SETUP,{ro:Array(12).fill(null),ru:Array(12).fill(null)});
        const cur=live[side][i]?.tnum||defT(i);
        CT.openModal({title:`Nummer #${i+1}`,html:`<label class="fld">Nummer<input id="_tn" value="${CT.escape(cur)}"></label>`,okText:'Speichern',cancelText:'Schließen',onOk:()=>{
          const val=(document.getElementById('_tn').value||cur).trim()||cur;
          const cell=live[side][i]||{}; cell.tnum=val; live[side][i]=cell; CT.storage.write(K.SETUP,live); CT.toast('Gespeichert','ok'); render();
        }});
      }

      return { render, setSide:(s)=>{side=s; render();} };
    })();

    // Привязки
    document.getElementById('btnChoose').onclick = ()=>Prog.choose();
    document.getElementById('btnNewTop').onclick = ()=>Prog.new();        // Кнопка в шапке
    document.getElementById('applyLive').onclick = ()=>Prog.applyToLive();
    document.getElementById('progTitle').onclick = ()=>Prog.edit();        // Клик по названию — редактор

    document.querySelectorAll('.tab').forEach(b=>{
      b.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); Live.setSide(b.dataset.side); };
    });
    document.getElementById('setupSearch').addEventListener('input', ()=>Live.render());
    CT.bindGlobalSearch(()=>Live.render());

    // старт
    Prog.render();
    Live.render();
  });
})();
</script>
</body>
</html>