<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Setup + Programme</title>
  <link rel="stylesheet" href="./ui/core.css?v=15">
  <style>
    /* Верхний инфоблок */
    .prog-head{display:grid;grid-template-columns:1fr 120px;gap:.75rem;align-items:center}
    .prog-left .title-line{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .prog-left .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
    .prog-right .thumb{width:120px;height:90px;border-radius:12px;background:#eef3ff;display:grid;place-items:center;
      color:#9cb1d9;font-weight:700;overflow:hidden;cursor:pointer;border:1px solid #e5ebf7}
    .prog-right .thumb img{width:100%;height:100%;object-fit:cover}

    /* Слоты */
    .slot-tnum{display:grid;grid-template-columns:72px 56px 1fr auto;gap:.6rem;align-items:center}
    .tnum-btn{min-width:64px}

    /* Fallback-модалка (если CT.openModal недоступен) */
    ._fx-modal{position:fixed;inset:0;z-index:9999;display:grid;place-items:center}
    ._fx-modal::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.25)}
    ._fx-card{position:relative;z-index:1;width:min(92vw,640px);max-height:86vh;overflow:auto;background:#fff;border-radius:16px;
      box-shadow:0 6px 24px rgba(13,27,42,.18);padding:12px}
    ._fx-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
  </style>
</head>
<body data-active="programme">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Setup + Programme</div></div>
    </a>
    <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen"><svg><use href="./ui/icons.svg#search"/></svg></button>
  </div>
</header>

<main class="container">
  <section class="section">
    <!-- Верхний блок -->
    <div class="prog-head">
      <div class="prog-left">
        <div class="title-line">
          <button class="select-like" id="progTitle">Programm wählen…</button>
          <button class="btn sm" id="chooseProg">Wechseln</button>
          <button class="btn brand sm" id="newProg">Neues Programm</button>
        </div>
        <div class="subtitle" id="progNumber">—</div>
      </div>
      <div class="prog-right">
        <div class="thumb" id="drawingThumb">no foto</div>
      </div>
    </div>

    <div class="tabs" style="margin-top:.75rem">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
      <button class="btn ok sm" id="applyLive" style="margin-left:auto">In Live anwenden</button>
    </div>

    <div id="slots" class="slots"></div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js?v=15"></script>
<script src="./ui/dock.js?v=15"></script>
<script>
(function(){
  // ===== helpers: storage, modal, toast =====
  const KEYS = window.CT_KEYS || { PROGS:'ct_programs_v1', SETUP:'ct_setup_live', TOOLS:'ct_tools_v2' };
  const read  = (k,def)=> window.CT ? CT.storage.read(k,def)  : (JSON.parse(localStorage.getItem(k)) ?? def);
  const write = (k,v)=> window.CT ? CT.storage.write(k,v) : localStorage.setItem(k, JSON.stringify(v));
  const toast = (m,t='ok')=> window.CT && CT.toast ? CT.toast(m,t,1400) : console.log('[toast]', m);
  const esc   = window.CT && CT.escape ? CT.escape : (s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])));

  if(window.CT && CT.ensureSeeds) CT.ensureSeeds();

  function openModal({title='', html=''}){  // без ок/кансела, все кнопки внутри html
    if(window.CT && CT.openModal){ CT.openModal({title, html, cancelText:'Schließen'}); return ()=>{CT.closeModal&&CT.closeModal();}; }
    const wrap = document.createElement('div');
    wrap.className='_fx-modal';
    wrap.innerHTML=`<div class="_fx-card"><div class="_fx-hdr"><b>${title}</b>
      <button class="icon-btn" id="_fxClose"><svg><use href="./ui/icons.svg#close"/></svg></button></div><div>${html}</div></div>`;
    document.body.appendChild(wrap); document.body.classList.add('noscroll');
    const close=()=>{ wrap.remove(); document.body.classList.remove('noscroll'); };
    wrap.addEventListener('click',(e)=>{ if(e.target===wrap) close(); });
    wrap.querySelector('#_fxClose').onclick=close;
    return close;
  }

  // ===== data =====
  let progs = read(KEYS.PROGS, []);
  let live  = read(KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
  let side='ro';
  let currentProgId = progs[0]?.id || null;

  const pad2=n=>String(n).padStart(2,'0');
  const defaultT=i=>`T${pad2(i+1)}${pad2(i+1)}`;

  // ===== header render =====
  const elTitle=document.getElementById('progTitle');
  const elNumber=document.getElementById('progNumber');
  const elThumb=document.getElementById('drawingThumb');

  function renderHeader(){
    const p = progs.find(x=>x.id===currentProgId);
    if(!p){
      elTitle.textContent='Programm wählen…'; elNumber.textContent='—'; elThumb.textContent='no foto'; elThumb.innerHTML='no foto'; return;
    }
    elTitle.textContent=p.title||'Programm';
    elNumber.textContent=`Nummer: ${p.number||'—'}`;
    elThumb.innerHTML = p.drawingData ? `<img src="${p.drawingData}" alt="">` : 'no foto';
  }

  // ===== editor modal (внутри свои кнопки с id) =====
  function openProgramEditor(p, isNew=false){
    const html = `
      ${p.drawingData?`<div class="imgwrap" style="margin-top:.25rem"><img src="${p.drawingData}" alt="" style="max-height:55vh;border-radius:12px"></div>`:
        `<div class="imgwrap" style="margin-top:.25rem"><div style="width:92vw;max-width:520px;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`}
      <div class="row" style="margin:.25rem 0">
        <label class="btn sm ghost" for="pr_file" style="cursor:pointer">Zeichnung anhängen</label>
        ${p.drawingData?'<button class="btn sm" id="btnView">Ansehen</button>':''}
        ${p.drawingData?'<button class="btn sm warn" id="btnRemove">Entfernen</button>':''}
      </div>
      <input id="pr_file" type="file" accept="image/*,application/pdf" style="display:none">
      <div class="muted" id="fileInfo">${p.drawingName?('Angehängt: '+esc(p.drawingName)):'Keine Zeichnung'}</div>

      <label class="fld" style="margin-top:.5rem">Titel<input id="pr_t" value="${esc(p.title||'')}" placeholder="Programmname"></label>
      <label class="fld">Nummer<input id="pr_n" inputmode="numeric" pattern="[0-9]*" value="${esc(p.number||'')}" placeholder="z.B. 1234"></label>

      <div class="row" style="margin-top:.75rem">
        ${!isNew?'<button class="btn warn" id="doDelete">Löschen</button>':''}
        <button class="btn brand" id="doSave" style="margin-left:auto">Speichern</button>
      </div>
    `;
    const close = openModal({title:isNew?'Neues Programm':'Programm', html});

    // бинды
    setTimeout(()=>{
      const file = document.getElementById('pr_file');
      let removeFlag=false;

      if(file) file.onchange=()=>{ const f=file.files?.[0]; if(f) document.getElementById('fileInfo').textContent='Ausgewählt: '+f.name; removeFlag=false; };
      const vBtn=document.getElementById('btnView');
      if(vBtn) vBtn.onclick=()=>{ if(!p.drawingData) return; const pdf=p.drawingData.startsWith('data:application/pdf');
        openModal({title:'Zeichnung', html: pdf?`<iframe src="${p.drawingData}" style="width:92vw;height:70vh;border:0;border-radius:12px"></iframe>`:`<div class="imgwrap"><img src="${p.drawingData}" alt="" style="max-height:70vh"></div>`}); };
      const rBtn=document.getElementById('btnRemove');
      if(rBtn) rBtn.onclick=()=>{ removeFlag=true; document.getElementById('fileInfo').textContent='Keine Zeichnung'; toast('Entfernt'); };

      const saveBtn=document.getElementById('doSave');
      saveBtn.onclick=async()=>{
        const up={...p};
        up.title=(document.getElementById('pr_t').value||'').trim()||'Programm';
        up.number=(document.getElementById('pr_n').value||'').trim()||up.number||1000;
        const f=file.files?.[0];
        if(f){
          if(window.CT && CT.readFileAsDataURL){ up.drawingName=f.name; up.drawingData=await CT.readFileAsDataURL(f); }
          else{ const r=new FileReader(); up.drawingName=f.name; await new Promise((res,rej)=>{ r.onload=()=>{up.drawingData=r.result;res();}; r.onerror=rej; r.readAsDataURL(f); }); }
        } else if(removeFlag){ up.drawingName=''; up.drawingData=''; }

        if(isNew) progs.push(up); else progs = progs.map(x=>x.id===up.id?up:x);
        write(KEYS.PROGS, progs);
        currentProgId = up.id;
        renderHeader();
        toast('Gespeichert','ok');
        close();
      };

      const delBtn=document.getElementById('doDelete');
      if(delBtn) delBtn.onclick=()=>{
        progs = progs.filter(x=>x.id!==p.id);
        write(KEYS.PROGS, progs);
        currentProgId = progs[0]?.id || null;
        renderHeader(); renderSlots();
        toast('Gelöscht','ok');
        close();
      };

      // автофокус
      const fT=document.getElementById('pr_t'); if(fT) fT.focus();
    },0);
  }

  // ===== choose program (список в модалке) =====
  function openChoose(){
    if(!progs.length){ toast('Keine Programme'); return; }
    const html = `<ul class="list" id="prList" style="list-style:none;margin:0;padding:0;display:grid;gap:.5rem">
      ${progs.map(p=>`<li data-id="${p.id}" class="card" style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
        <div><b>${esc(p.title)}</b><div class="muted">#${esc(p.number)}</div></div>
        <div class="row"><button class="btn sm sel">Wählen</button><button class="btn sm" data-edit>Bearbeiten</button></div>
      </li>`).join('')}
    </ul>`;
    const close = openModal({title:'Programme', html});
    setTimeout(()=>{
      document.querySelectorAll('#prList li').forEach(li=>{
        const id=li.dataset.id;
        li.querySelector('.sel').onclick=()=>{ currentProgId=id; renderHeader(); renderSlots(); close(); };
        li.querySelector('[data-edit]').onclick=()=>{ const cur=progs.find(x=>x.id===id); close(); if(cur) openProgramEditor(cur,false); };
      });
    },0);
  }

  // ===== slots =====
  function renderSlots(){
    const root=document.getElementById('slots'); root.innerHTML='';
    const data=live[side];
    const tools=read(KEYS.TOOLS,[]);
    for(let i=0;i<12;i++){
      const cell=document.createElement('div'); cell.className='slot';
      const v=data[i];
      const tnum=(v&&v.tnum)?v.tnum:defaultT(i);
      const tbtn=`<button class="badge tnum-btn" data-tnum="${i}">${esc(tnum)}</button>`;
      if(!v){
        cell.innerHTML=`<div class="slot-full slot-tnum">${tbtn}
          <div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>
          <div class="meta"><div class="name"><b>#${i+1} • Leer</b></div><div class="sub">—</div></div>
          <div class="tail"><button class="btn" data-add="${i}">Hinzufügen</button></div></div>`;
      } else {
        const t=tools.find(x=>x.id===v.toolId);
        const name=t?t.name:'—'; const code=t?t.code:'';
        const thumb=t?.imgData?`<img class="thumb" src="${t.imgData}" style="width:56px;height:56px;object-fit:cover;border-radius:10px;background:#f0f3fa">`
                              :`<div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>`;
        cell.innerHTML=`<div class="slot-full slot-tnum">${tbtn}${thumb}
          <div class="meta"><div class="name"><b>${esc(name)}</b></div><div class="sub">${esc(code)}</div></div>
          <div class="tail" style="display:flex;gap:.25rem">
            <button class="icon-btn info" data-info="${i}"><svg><use href="./ui/icons.svg#info"/></svg></button>
            <button class="icon-btn" data-change="${i}"><svg><use href="./ui/icons.svg#edit"/></svg></button>
          </div></div>`;
      }
      root.appendChild(cell);
    }
    // handlers
    root.querySelectorAll('[data-add]').forEach(b=>b.onclick=()=>assignTool(+b.dataset.add));
    root.querySelectorAll('[data-change]').forEach(b=>b.onclick=()=>assignTool(+b.dataset.change,true));
    root.querySelectorAll('[data-info]').forEach(b=>b.onclick=()=>slotInfo(+b.dataset.info));
    root.querySelectorAll('[data-tnum]').forEach(b=>b.onclick=()=>editTnum(+b.dataset.tnum));
  }

  function assignTool(idx, cycle=false){
    const tools=read(KEYS.TOOLS,[]);
    if(!tools.length){ toast('Keine Werkzeuge'); return; }
    if(cycle){
      const cur=live[side][idx]?.toolId;
      const i=tools.findIndex(t=>t.id===cur);
      const next=(i>=0 && i<tools.length-1)?i+1:0;
      const prev=live[side][idx]||{};
      live[side][idx]={toolId:tools[next].id, tnum:(prev.tnum||defaultT(idx))};
    }else{
      const prev=live[side][idx]||{};
      live[side][idx]={toolId:tools[0].id, tnum:(prev.tnum||defaultT(idx))};
    }
    write(KEYS.SETUP, live); renderSlots();
  }

  function slotInfo(i){
    const v=live[side][i]; if(!v){ toast('Kein Werkzeug','err'); return; }
    const t=read(KEYS.TOOLS,[]).find(x=>x.id===v.toolId); if(!t){ toast('Kein Werkzeug','err'); return; }
    const big=t.imgData?`<div class="imgwrap"><img src="${t.imgData}" style="max-height:70vh"></div>`
                       :`<div class="imgwrap"><div style="width:92vw;max-width:520px;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`;
    const close=openModal({title:`Position #${i+1}`, html:`${big}<b>${esc(t.name)}</b><div class="i-row">${esc(t.code)}</div>
      <div class="row"><button class="btn warn" id="btnRem">Entfernen</button></div>`});
    setTimeout(()=>{ const r=document.getElementById('btnRem'); if(r) r.onclick=()=>{ live[side][i]=null; write(KEYS.SETUP,live); renderSlots(); close(); }; },0);
  }

  function editTnum(i){
    const v=live[side][i]||{}; const cur=v.tnum||defaultT(i);
    const close=openModal({title:`Nummer #${i+1}`, html:`<label class="fld">Nummer<input id="tnVal" value="${esc(cur)}"></label>
      <div class="row" style="margin-top:.5rem"><button class="btn brand" id="tnSave" style="margin-left:auto">Speichern</button></div>`});
    setTimeout(()=>{ const s=document.getElementById('tnSave'); const inp=document.getElementById('tnVal'); if(inp) inp.focus();
      if(s) s.onclick=()=>{ const val=(inp.value||cur).trim()||cur; const cell=live[side][i]||{}; cell.tnum=val; live[side][i]=cell; write(KEYS.SETUP,live); renderSlots(); close(); }; },0);
  }

  // ===== header actions =====
  document.getElementById('newProg').onclick=()=>{
    const p={id:(window.CT?CT.uid():Math.random().toString(36).slice(2,9)), number:1000+Math.floor(Math.random()*9000),
      title:'Neues Programm', date:Date.now(), ro:Array(12).fill(null), ru:Array(12).fill(null), drawingName:'', drawingData:''};
    openProgramEditor(p, true);
  };
  document.getElementById('chooseProg').onclick=()=>openChoose();
  document.getElementById('progTitle').onclick=()=>{
    const p=progs.find(x=>x.id===currentProgId); if(!p) return openChoose(); openProgramEditor(p,false);
  };
  document.getElementById('drawingThumb').onclick=()=>{
    const p=progs.find(x=>x.id===currentProgId); if(!p){ toast('Kein Programm'); return; } openProgramEditor(p,false);
  };
  document.getElementById('applyLive').onclick=()=>{
    const p=progs.find(x=>x.id===currentProgId); if(!p) return;
    live={ro:p.ro||Array(12).fill(null), ru:p.ru||Array(12).fill(null)}; write(KEYS.SETUP, live); toast('In Live angewendet'); renderSlots();
  };

  // tabs
  document.querySelectorAll('.tab').forEach(b=>{
    b.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); side=b.dataset.side; renderSlots(); };
  });

  // init
  renderHeader(); renderSlots();
})();
</script>
</body>
</html>