<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Setup</title>
  <link rel="stylesheet" href="./ui/core.css">
</head>
<body data-active="programme">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Setup</div></div>
    </a>
    <div class="actions">
      <button class="btn brand sm" id="newProgTop">Neues Programm</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen"><svg><use href="./ui/icons.svg#search"/></svg></button>
    </div>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Im Setup suchen…" id="setupSearch"></div>

<main class="container">
  <!-- Программа: шапка -->
  <section class="section" id="progHeader">
    <div class="row between">
      <div>
        <div class="row">
          <div class="select-like" id="progSelect">Programm wählen…</div>
          <button class="icon-btn info" id="editProg" aria-label="Bearbeiten"><svg><use href="./ui/icons.svg#edit"/></svg></button>
        </div>
        <div class="muted" id="progMeta">Nr — / Seite —</div>
      </div>
      <div class="row">
        <div id="drawingWrap" class="card" style="width:96px;height:96px;display:grid;place-items:center;border-radius:12px">
          <span class="muted">no foto</span>
        </div>
      </div>
    </div>
    <div class="tabs mt">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
    </div>
  </section>

  <!-- Слоты -->
  <section class="section">
    <div id="slots" class="slots"></div>
  </section>
</main>
<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();

  let progs = CT.storage.read(CT.CT_KEYS.PROGS, []);
  let live  = CT.storage.read(CT.CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
  let side  = 'ro';
  let currentProgId = progs[0]?.id || null;

  function progTitle(p){ return `#${p.number} — ${p.title}`; }
  function refreshHeader(){
    progs = CT.storage.read(CT.CT_KEYS.PROGS, []);
    const cur = progs.find(p=>p.id===currentProgId);
    document.getElementById('progSelect').textContent = cur? progTitle(cur) : 'Programm wählen…';
    document.getElementById('progMeta').textContent   = cur? `Nr ${cur.number} • Seite ${side==='ro'?'RO (G54)':'RU (G55)'}` : 'Nr — / Seite —';
    const dw = document.getElementById('drawingWrap');
    if(cur?.drawing){
      dw.innerHTML = `<img src="${cur.drawing}" alt="" style="width:96px;height:96px;object-fit:cover;border-radius:10px">`;
    }else{
      dw.innerHTML = `<span class="muted">no foto</span>`;
    }
  }

  function openProgMenu(){
    const items = progs.map(p=>({id:p.id, title:progTitle(p), meta:new Date(p.date).toLocaleDateString()}));
    CT.openDrawer({title:'Programme', items, onSelect:(id)=>{ currentProgId=id; CT.closeDrawer(); refreshHeader(); render(); }});
  }

  function openProgEditor(pIn){
    const p = pIn || progs.find(x=>x.id===currentProgId);
    const isNew = !p;
    const cur = p || {id:CT.uid(), number:'', title:'', date:Date.now(), ro:Array(12).fill(null), ru:Array(12).fill(null), drawing:null};
    const html = `
      <label class="fld">Zeichnung / Foto<input id="pr_img" type="file" accept="image/*"></label>
      <label class="fld">Titel<input id="pr_t" value="${CT.escape(cur.title)}" placeholder="Programm"></label>
      <label class="fld">Nummer<input id="pr_n" value="${CT.escape(cur.number)}" placeholder="123456"></label>
      ${!isNew?'<div class="row"><button class="btn warn" id="del">Löschen</button></div>':''}
    `;
    CT.openModal({title:isNew?'Neues Programm':'Programm bearbeiten', html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
      const up = {...cur};
      up.title=document.getElementById('pr_t').value||'Programm';
      up.number=document.getElementById('pr_n').value||'—';
      const file=document.getElementById('pr_img').files?.[0];
      const commit=()=>{
        let arr=CT.storage.read(CT.CT_KEYS.PROGS,[]);
        const i=arr.findIndex(x=>x.id===up.id);
        if(i>-1)arr[i]=up; else arr.push(up);
        CT.storage.write(CT.CT_KEYS.PROGS, arr);
        currentProgId=up.id; refreshHeader(); CT.toast('Gespeichert','ok'); render();
      };
      if(file){ CT.readFileAsDataURL(file).then(data=>{up.drawing=data; commit();}); } else commit();
    }});
    const del=document.getElementById('del');
    if(del) del.onclick=()=>{ progs = progs.filter(x=>x.id!==cur.id); CT.storage.write(CT.CT_KEYS.PROGS,progs); currentProgId=progs[0]?.id||null; CT.closeModal(); refreshHeader(); render(); CT.toast('Gelöscht','ok'); };
  }

  function render(){
    const root=document.getElementById('slots'); root.innerHTML='';
    const data = live[side];
    const tools = CT.storage.read(CT.CT_KEYS.TOOLS, []);
    const q = (document.getElementById('setupSearch').value||'').toLowerCase();

    for(let i=0;i<12;i++){
      const cell = document.createElement('div'); cell.className='slot';
      const v = data[i];
      if(!v){
        cell.innerHTML = `<div class="slot-empty">
          <div class="muted">#${i+1} • Frei</div>
          <button class="btn" data-i="${i}">Hinzufügen</button></div>`;
        cell.querySelector('button').onclick=()=>selectToolFor(i);
      }else{
        const t = tools.find(x=>x.id===v.toolId);
        const name = t? t.name : '—';
        const code = t? t.code : '';
        if(q && !(name.toLowerCase().includes(q)||code.toLowerCase().includes(q))) { continue; }
        cell.innerHTML = `
          <div class="slot-full">
            <button class="btn tnum-btn" id="tn_${i}">T${String(i+1).padStart(2,'0')}${String(i+1).padStart(2,'0')}</button>
            ${t?.imgData?`<img class="thumb" src="${t.imgData}" alt="">`:`<div class="thumb" style="display:grid;place-items:center;color:#9cb1d9">No</div>`}
            <div class="meta">
              <div class="name" style="font-weight:800">${CT.escape(name)}</div>
              <div class="muted">${CT.escape(code)}</div>
            </div>
            <div class="tail">
              <button class="icon-btn info" aria-label="Info" id="i_${i}"><svg><use href="./ui/icons.svg#info"/></svg></button>
              <button class="btn ghost sm" data-i="${i}">Wechseln</button>
            </div>
          </div>`;
        cell.querySelector('.btn.ghost').onclick=()=> selectToolFor(i);
        cell.querySelector(`#i_${i}`).onclick=()=> infoSlot(i);
        cell.querySelector(`#tn_${i}`).onclick=()=> editTNum(i);
      }
      root.appendChild(cell);
    }
  }

  function editTNum(i){
    const html = `<label class="fld">T-Nummer (Anzeige)<input id="t_num" placeholder="например T0101"></label>`;
    CT.openModal({title:`Slot #${i+1}`, html, okText:'OK', onOk:()=>{ const v=document.getElementById('t_num').value||''; document.getElementById(`tn_${i}`).textContent = v||document.getElementById(`tn_${i}`).textContent; CT.toast('Aktualisiert','ok'); }});
  }

  function selectToolFor(idx){
    const tools = CT.storage.read(CT.CT_KEYS.TOOLS, []);
    if(!tools.length){ return CT.toast('Keine Tools','err'); }
    const items = tools.map(t=>({id:t.id, title:t.name, meta:t.code}));
    CT.openDrawer({title:`Werkzeug wählen (#${idx+1})`, items, onSelect:(id)=>{
      live[side][idx] = {toolId:id, note:''};
      CT.storage.write(CT.CT_KEYS.SETUP, live); CT.closeDrawer(); CT.toast('Aktualisiert','ok'); render();
    }});
  }

  function infoSlot(i){
    const v = live[side][i]; if(!v){ CT.toast('Leer','err'); return; }
    const tAll = CT.storage.read(CT.CT_KEYS.TOOLS, []);
    const t = tAll.find(x=>x.id===v.toolId);
    const html = `
      ${t?.imgData?`<div class="imgwrap"><img src="${t.imgData}" alt=""></div>`:''}
      <b>${CT.escape(t?.name||'—')}</b>
      <div class="muted">${CT.escape(t?.code||'')}</div>
      <div class="row">
        <button class="btn warn" id="rem">Entfernen</button>
        <button class="btn brand" id="openTools">Werkzeug öffnen</button>
      </div>`;
    CT.openModal({title:`Position #${i+1}`, html, cancelText:'Schließen'});
    document.getElementById('rem').onclick=()=>{ live[side][i]=null; CT.storage.write(CT.CT_KEYS.SETUP,live); CT.closeModal(); render(); };
    document.getElementById('openTools').onclick=()=>{ location.href='./tools.html'; };
  }

  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); side=b.dataset.side; refreshHeader(); render();});
  document.getElementById('progSelect').onclick=openProgMenu;
  document.getElementById('editProg').onclick=()=>openProgEditor();
  document.getElementById('newProgTop').onclick=()=>openProgEditor(null);
  document.getElementById('setupSearch').addEventListener('input', render);

  refreshHeader(); render();
});
</script>
</body>
</html>