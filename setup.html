<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Programme + Setup</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    .errbar{position:fixed;left:8px;right:8px;top:8px;z-index:9999;background:#fff3f3;border:1px solid #f3c2c2;color:#7a1e1e;border-radius:12px;padding:10px;box-shadow:0 6px 24px rgba(0,0,0,.12);font-size:14px}
    .select-like.thumb{display:grid;place-items:center;min-width:120px;min-height:44px}
    .slot-tnum{display:grid;grid-template-columns:72px 56px 1fr auto;gap:.6rem;align-items:center}
    .tnum-btn.badge{min-width:64px}
  </style>
</head>
<body data-active="programme">
<noscript><div class="section" style="margin:12px">Bitte JavaScript aktivieren.</div></noscript>

<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <img src="./ui/brand.png" class="badge" alt="CT">
      <div class="tit">
        <div class="title">CitiTool</div>
        <div class="subtitle">Programme + Setup</div>
      </div>
    </a>
    <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
      <svg><use href="./ui/icons.svg#search"/></svg>
    </button>
  </div>
</header>

<div class="searchbar collapsed">
  <input class="field" type="search" placeholder="Im Setup suchen…" id="setupSearch">
</div>

<main class="container">
  <section class="section" id="progSection">
    <h2>Programme</h2>
    <div class="row between">
      <div class="row">
        <div class="select-like" id="progTitle">Programm wählen…</div>
        <button class="btn sm" id="btnChoose">Wechseln</button>
        <button class="btn brand sm" id="btnNew">Neues Programm</button>
        <button class="btn sm" id="btnEdit">Bearbeiten</button>
      </div>
      <div class="row">
        <div id="progNumber" class="muted"># —</div>
        <div class="select-like thumb" id="thumbBtn">no foto</div>
      </div>
    </div>
    <div class="row mt">
      <button class="btn ok" id="applyLive">In Live anwenden</button>
    </div>
  </section>

  <section class="section">
    <h2>Setup (Live)</h2>
    <div class="tabs">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
    </div>
    <div id="slots" class="slots"></div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script>
(function(){
  window.addEventListener('error', e=>{
    const el=document.createElement('div');
    el.className='errbar';
    el.textContent='Fehler: '+e.message+' @ '+e.filename+':'+e.lineno;
    document.body.appendChild(el);
  });
})();
</script>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>

<script>
CT.ready(()=>{
  try{
    CT.ensureSeeds();
    const SKEY = CT.CT_KEYS;
    let progs = CT.storage.read(SKEY.PROGS, []);
    let live  = CT.storage.read(SKEY.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
    let side  = 'ro';
    let currentProgId = progs[0]?.id || null;

    const elTitle = document.getElementById('progTitle');
    const elNum   = document.getElementById('progNumber');
    const elThumb = document.getElementById('thumbBtn');
    const slots   = document.getElementById('slots');

    const pad2=n=>String(n).padStart(2,'0');
    const defT=i=>'T'+pad2(i+1)+pad2(i+1);
    const curProg=()=>progs.find(p=>p.id===currentProgId)||null;

    function renderProgramme(){
      const p=curProg();
      if(!p){ elTitle.textContent='Programm wählen…'; elNum.textContent='# —'; elThumb.textContent='no foto'; return; }
      elTitle.textContent=p.title; elNum.textContent='#'+p.number;
      elThumb.innerHTML=p.drawingData?`<img src="${p.drawingData}" style="height:44px;border-radius:8px">`:'no foto';
    }

    function renderSlots(){
      live=CT.storage.read(SKEY.SETUP, live);
      const tools=CT.storage.read(SKEY.TOOLS,[]);
      slots.innerHTML='';
      for(let i=0;i<12;i++){
        const v=live[side][i];
        const tnum=v?.tnum||defT(i);
        const wrap=document.createElement('div'); wrap.className='slot';
        if(!v){
          wrap.innerHTML=`
          <div class="slot-full slot-tnum">
            <span class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</span>
            <div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>
            <div class="meta"><b>#${i+1} • Leer</b><div class="sub">—</div></div>
            <div class="tail"><button class="btn sm" data-add="${i}">Hinzufügen</button></div>
          </div>`;
        }else{
          const t=tools.find(x=>x.id===v.toolId);
          const name=t?t.name:'—', code=t?t.code:'';
          const thumb=t?.imgData?`<img src="${t.imgData}" style="width:56px;height:56px;object-fit:cover;border-radius:10px">`:`<div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>`;
          wrap.innerHTML=`
          <div class="slot-full slot-tnum">
            <span class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</span>
            ${thumb}
            <div class="meta"><b>${CT.escape(name)}</b><div class="sub">${CT.escape(code)}</div></div>
            <div class="tail" style="display:flex;gap:.25rem">
              <button class="icon-btn info" data-info="${i}"><svg><use href="./ui/icons.svg#info"/></svg></button>
              <button class="icon-btn" data-change="${i}"><svg><use href="./ui/icons.svg#edit"/></svg></button>
            </div>
          </div>`;
        }
        slots.appendChild(wrap);
      }
      slots.querySelectorAll('[data-add]').forEach(b=>b.onclick=()=>selectToolFor(+b.dataset.add));
      slots.querySelectorAll('[data-change]').forEach(b=>b.onclick=()=>selectToolFor(+b.dataset.change,true));
      slots.querySelectorAll('[data-info]').forEach(b=>b.onclick=()=>slotInfo(+b.dataset.info));
      slots.querySelectorAll('[data-tnum]').forEach(b=>b.onclick=()=>editTnum(+b.dataset.tnum));
    }

    function selectToolFor(idx,cycle=false){
      const tools=CT.storage.read(SKEY.TOOLS,[]);
      if(!tools.length){CT.toast('Keine Werkzeuge','err');return;}
      if(cycle){
        const cur=live[side][idx]?.toolId;
        const i=tools.findIndex(t=>t.id===cur);
        const next=(i>=0&&i<tools.length-1)?i+1:0;
        const prev=live[side][idx]||{};
        live[side][idx]={toolId:tools[next].id,tnum:(prev.tnum||defT(idx))};
        CT.storage.write(SKEY.SETUP,live);renderSlots();return;
      }
      const items=tools.map(t=>({id:t.id,title:t.name,meta:t.code}));
      CT.openDrawer({title:`Werkzeug wählen (#${idx+1})`,items,onSelect:id=>{
        const prev=live[side][idx]||{};
        live[side][idx]={toolId:id,tnum:(prev.tnum||defT(idx))};
        CT.storage.write(SKEY.SETUP,live);CT.closeDrawer();CT.toast('Aktualisiert','ok');renderSlots();
      }});
    }

    function slotInfo(i){
      const t=CT.getToolFromSlot(live,side,i);
      if(!t){CT.toast('Kein Werkzeug','err');return;}
      const html=t.imgData?`<div class="imgwrap"><img src="${t.imgData}"></div>`:`<div class="imgwrap"><div style="aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`;
      CT.openModal({title:`Position #${i+1}`,html:`${html}<b>${t.name}</b><div class="i-row">${t.code}</div><div class="row"><button class="btn warn" id="btnRem">Entfernen</button></div>`,cancelText:'Schließen'});
      setTimeout(()=>{const r=document.getElementById('btnRem');if(r)r.onclick=()=>{live[side][i]=null;CT.storage.write(SKEY.SETUP,live);CT.closeModal();renderSlots();};},0);
    }

    function editTnum(i){
      const v=live[side][i]||{},cur=v.tnum||defT(i);
      CT.openModal({title:`Nummer #${i+1}`,html:`<label class="fld">Nummer<input id="_tn" value="${CT.escape(cur)}"></label>`,okText:'Speichern',cancelText:'Schließen',onOk:()=>{
        const val=(document.getElementById('_tn').value||cur).trim()||cur;
        const cell=live[side][i]||{};cell.tnum=val;live[side][i]=cell;
        CT.storage.write(SKEY.SETUP,live);CT.toast('Gespeichert','ok');renderSlots();
      }});
    }

    document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');side=b.dataset.side;renderSlots();});
    document.getElementById('applyLive').onclick=()=>{const p=curProg();if(!p)return;live={ro:p.ro||Array(12).fill(null),ru:p.ru||Array(12).fill(null)};CT.storage.write(SKEY.SETUP,live);CT.toast('In Live angewendet','ok');renderSlots();};
    document.getElementById('btnChoose').onclick=()=>{const items=progs.map(p=>({id:p.id,title:'#'+p.number+' '+p.title,meta:new Date(p.date).toLocaleDateString()}));CT.openDrawer({title:'Programme',items,onSelect:id=>{currentProgId=id;CT.closeDrawer();renderProgramme();renderSlots();}});};
    document.getElementById('btnNew').onclick=()=>{const p={id:CT.uid(),number:1000+Math.floor(Math.random()*9000),title:'Neues Programm',date:Date.now(),ro:Array(12).fill(null),ru:Array(12).fill(null)};progs.push(p);CT.storage.write(SKEY.PROGS,progs);currentProgId=p.id;renderProgramme();CT.toast('Erstellt','ok');};
    document.getElementById('btnEdit').onclick=()=>{const p=curProg();if(!p)return CT.toast('Kein Programm','err');CT.openModal({title:'Programm bearbeiten',html:`<label class="fld">Titel<input id="t" value="${p.title}"></label><label class="fld">Nummer<input id="n" value="${p.number}"></label>`,okText:'Speichern',cancelText:'Schließen',onOk:()=>{p.title=document.getElementById('t').value;p.number=document.getElementById('n').value;CT.storage.write(SKEY.PROGS,progs);renderProgramme();CT.toast('Gespeichert','ok');}});};
    elTitle.onclick=()=>{const p=curProg();if(!p)CT.toast('Kein Programm','err');else document.getElementById('btnEdit').click();};
    elThumb.onclick=()=>document.getElementById('btnEdit').click();

    renderProgramme(); renderSlots();
  }catch(e){console.error(e);}
});
</script>
</body>
</html>