<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Setup + Programme</title>
  <link rel="stylesheet" href="./ui/core.css?v=12">
  <style>
    .slot-tnum{display:grid;grid-template-columns:72px 56px 1fr auto;gap:.6rem;align-items:center}
    .tnum-btn{min-width:64px}
  </style>
</head>
<body data-active="programme">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge">CT</span>
      <div class="tit">
        <div class="title">CitiTool</div>
        <div class="subtitle">Setup + Programme</div>
      </div>
    </a>
    <button class="icon-btn" data-ct="search-toggle"><svg><use href="./ui/icons.svg#search"/></svg></button>
  </div>
</header>

<main class="container">
  <section class="section">
    <div class="row between">
      <div class="select-like" id="progSelect">Programm wählen…</div>
      <button class="icon-btn info" id="progInfo"><svg><use href="./ui/icons.svg#info"/></svg></button>
    </div>

    <div class="tabs">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
    </div>

    <div id="slots" class="slots"></div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js?v=12"></script>
<script src="./ui/dock.js?v=12"></script>
<script>
CT.ready(()=>{
  console.log("Setup clean v12");
  CT.ensureSeeds();

  let progs = CT.storage.read(CT_KEYS.PROGS, []);
  let live  = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
  let side = 'ro';
  let currentProgId = progs[0]?.id || null;

  const pad2 = n => String(n).padStart(2,'0');
  const defaultTnum = i => `T${pad2(i+1)}${pad2(i+1)}`;
  const progTitle = p => `#${p.number} — ${p.title}`;

  function refreshProgSelect(){
    const cur = progs.find(p=>p.id===currentProgId);
    document.getElementById('progSelect').textContent = cur ? progTitle(cur) : 'Programm wählen…';
  }

  // === Создать / редактировать программу ===
  function editProgram(p, isNew=false){
    let removeFlag = false;
    const html = `
      <label class="fld">Nummer
        <input id="pr_n" type="text" inputmode="numeric" pattern="[0-9]*" value="${CT.escape(p.number)}" placeholder="z.B. 1234">
      </label>
      <label class="fld">Titel
        <input id="pr_t" type="text" value="${CT.escape(p.title)}" placeholder="Programmname">
      </label>
      <div class="row" style="margin:.4rem 0">
        <label class="btn sm ghost" for="pr_file">Zeichnung anhängen</label>
        ${p.drawingData ? '<button class="btn sm" id="view">Ansehen</button>' : ''}
        ${p.drawingData ? '<button class="btn sm warn" id="remove">Entfernen</button>' : ''}
      </div>
      <input id="pr_file" type="file" accept="image/*,application/pdf" style="display:none">
      <div class="muted" id="fileInfo">${p.drawingName?('Angehängt: '+CT.escape(p.drawingName)):'Keine Zeichnung'}</div>
      ${!isNew?'<div class="row"><button class="btn warn" id="del">Löschen</button></div>':''}
    `;
    CT.openModal({
      title:isNew?'Neues Programm':'Programm',
      html, okText:'Speichern', cancelText:'Schließen',
      onOk:async()=>{
        const up={...p};
        up.number=document.getElementById('pr_n').value.trim()||p.number;
        up.title=document.getElementById('pr_t').value.trim()||p.title;
        const f=document.getElementById('pr_file').files?.[0];
        if(f){ up.drawingName=f.name; up.drawingData=await CT.readFileAsDataURL(f); }
        else if(removeFlag){ up.drawingName=''; up.drawingData=''; }
        if(isNew) progs.push(up); else progs=progs.map(x=>x.id===up.id?up:x);
        CT.storage.write(CT_KEYS.PROGS,progs);
        currentProgId=up.id; refreshProgSelect(); CT.toast('Gespeichert','ok');
      }
    });

    const modal=document.querySelector('.modal .card');
    const file=document.getElementById('pr_file');
    file.onchange=()=>{const f=file.files?.[0]; if(f)document.getElementById('fileInfo').textContent='Ausgewählt: '+f.name; removeFlag=false;};
    const vBtn=document.getElementById('view'); if(vBtn)vBtn.onclick=()=>{const d=p.drawingData;if(!d)return;const pdf=d.startsWith('data:application/pdf');CT.openModal({title:'Zeichnung',html:pdf?'<iframe src="'+d+'" style="width:92vw;height:70vh;border:0;border-radius:12px"></iframe>':'<div class=imgwrap><img src="'+d+'" style=max-height:70vh></div>',cancelText:'Schließen'});}
    const rBtn=document.getElementById('remove'); if(rBtn)rBtn.onclick=()=>{removeFlag=true;document.getElementById('fileInfo').textContent='Keine Zeichnung';CT.toast('Entfernt','ok');};
    const dBtn=document.getElementById('del'); if(dBtn)dBtn.onclick=()=>{progs=progs.filter(x=>x.id!==p.id);CT.storage.write(CT_KEYS.PROGS,progs);currentProgId=progs[0]?.id||null;CT.closeModal();refreshProgSelect();render();CT.toast('Gelöscht','ok');};
  }

  function createNewProgram(){
    const p={id:CT.uid(),number:1000+Math.floor(Math.random()*9000),title:'Neues Programm',date:Date.now(),ro:Array(12).fill(null),ru:Array(12).fill(null),drawingName:'',drawingData:''};
    editProgram(p,true);
  }

  function openProgramMenu(){
    progs=CT.storage.read(CT_KEYS.PROGS,[]);
    const html=`<div class=row style="margin-bottom:.5rem"><button class="btn sm" id="newProg">+ Neues Programm</button></div>
      <ul class=list>${progs.map(p=>`<li data-id="${p.id}">
        <div><b>${CT.escape(progTitle(p))}</b></div>
        <div class=row><button class="btn sm sel">Wählen</button><button class="btn sm" data-edit>Bearbeiten</button></div>
      </li>`).join('')||'<li class=muted>Keine Programme</li>'}</ul>`;
    CT.openDrawer({title:'Programme',html});
    const dr=document.querySelector('.drawer');
    dr.querySelector('#newProg').onclick=()=>{CT.closeDrawer();createNewProgram();};
    dr.querySelectorAll('li').forEach(li=>{
      const id=li.dataset.id;
      li.querySelector('.sel').onclick=()=>{currentProgId=id;CT.closeDrawer();refreshProgSelect();render();};
      li.querySelector('[data-edit]').onclick=()=>{CT.closeDrawer();const cur=progs.find(x=>x.id===id);if(cur)editProgram(cur,false);};
    });
  }

  function applyToLive(){
    const p=progs.find(x=>x.id===currentProgId);if(!p)return;
    live={ro:p.ro||Array(12).fill(null),ru:p.ru||Array(12).fill(null)};
    CT.storage.write(CT_KEYS.SETUP,live);
    CT.toast('In Live angewendet','ok');
    render();
  }

  // ==== Слоты ====
  function render(){
    const root=document.getElementById('slots');root.innerHTML='';
    const data=live[side];const tools=CT.storage.read(CT_KEYS.TOOLS,[]);
    for(let i=0;i<12;i++){
      const cell=document.createElement('div');cell.className='slot';
      const v=data[i];const tnum=(v&&v.tnum)?v.tnum:defaultTnum(i);
      const tnumBtn=`<button class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</button>`;
      if(!v){
        cell.innerHTML=`<div class="slot-full slot-tnum">${tnumBtn}<div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div><div class=meta><b>#${i+1} • Leer</b></div><div class=tail><button class="btn" data-i="${i}">Hinzufügen</button></div></div>`;
        cell.querySelector('[data-i]').onclick=()=>selectToolFor(i);
        cell.querySelector('[data-tnum]').onclick=()=>editSlotNumber(i);
      }else{
        const t=tools.find(x=>x.id===v.toolId);
        const name=t?t.name:'—';const code=t?t.code:'';
        const thumb=t?.imgData?`<img class=thumb src="${t.imgData}" style="width:56px;height:56px;object-fit:cover;border-radius:10px;background:#f0f3fa">`:`<div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>`;
        cell.innerHTML=`<div class="slot-full slot-tnum">${tnumBtn}${thumb}<div class=meta><b>${CT.escape(name)}</b><div>${CT.escape(code)}</div></div><div class=tail><button class="icon-btn info"><svg><use href="./ui/icons.svg#info"/></svg></button><button class="icon-btn" data-edit><svg><use href="./ui/icons.svg#edit"/></svg></button></div></div>`;
        cell.querySelector('.icon-btn.info').onclick=()=>infoSlot(i);
        cell.querySelector('[data-edit]').onclick=()=>selectToolFor(i);
        cell.querySelector('[data-tnum]').onclick=()=>editSlotNumber(i);
      }
      root.appendChild(cell);
    }
  }

  function selectToolFor(i){
    const tools=CT.storage.read(CT_KEYS.TOOLS,[]);
    CT.openDrawer({title:`Werkzeug wählen (#${i+1})`,items:tools.map(t=>({id:t.id,title:t.name,meta:t.code})),onSelect:id=>{
      const prev=live[side][i]||{};live[side][i]={toolId:id,tnum:prev.tnum||defaultTnum(i)};
      CT.storage.write(CT_KEYS.SETUP,live);CT.closeDrawer();render();
    }});
  }

  function infoSlot(i){
    const cell=live[side][i];const t=CT.getToolFromSlot(live,side,i);const tnum=(cell&&cell.tnum)?cell.tnum:defaultTnum(i);
    if(!t)return CT.toast('Kein Werkzeug','err');
    const html=`${t.imgData?`<div class=imgwrap><img src="${t.imgData}" style=max-height:70vh></div>`:`<div class=imgwrap><div style="width:92vw;max-width:520px;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`}
    <b>${CT.escape(t.name)}</b><div>${CT.escape(t.code)}</div><div class=row><button class="btn sm" id="rem">Entfernen</button></div>`;
    CT.openModal({title:`Position #${i+1}`,html,cancelText:'Schließen'});
    const m=document.querySelector('.modal .card');m.querySelector('#rem').onclick=()=>{live[side][i]=null;CT.storage.write(CT_KEYS.SETUP,live);CT.closeModal();render();};
  }

  function editSlotNumber(i){
    const v=live[side][i]||{};const cur=v.tnum||defaultTnum(i);
    CT.openModal({title:`Nummer #${i+1}`,html:`<label class=fld>Nummer<input id=tin value="${CT.escape(cur)}"></label>`,okText:'OK',onOk:()=>{const val=document.getElementById('tin').value||cur;const cell=live[side][i]||{};cell.tnum=val;live[side][i]=cell;CT.storage.write(CT_KEYS.SETUP,live);render();}});
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');side=t.dataset.side;render();});

  // i меню
  document.getElementById('progInfo').onclick=()=>{
    const html=`<div class=row><button class=btn id=new>Neues Programm</button><button class="btn ok" id=apply>In Live anwenden</button><button class="btn brand" id=edit>Bearbeiten</button></div>`;
    CT.openModal({title:'Programm',html,cancelText:'Schließen'});
    const m=document.querySelector('.modal .card');
    m.querySelector('#new').onclick=()=>{CT.closeModal();createNewProgram();};
    m.querySelector('#apply').onclick=()=>{CT.closeModal();applyToLive();};
    m.querySelector('#edit').onclick=()=>{CT.closeModal();const cur=progs.find(x=>x.id===currentProgId);if(cur)editProgram(cur,false);};
  };

  document.getElementById('progSelect').onclick=openProgramMenu;

  refreshProgSelect();
  render();
});
</script>
</body>
</html>