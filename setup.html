<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Setup 2.0</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    /* локальные штрихи без нарушения /ui */
    .hero-drawing{display:grid;place-items:center;width:100%;height:200px;border:1px dashed #dfe6f7;border-radius:14px;background:#fafcff;overflow:hidden}
    .hero-drawing img{width:100%;height:100%;object-fit:contain}
    .hero-placeholder{display:grid;place-items:center;gap:.4rem;color:#8aa0c5}
    .hero-placeholder .ct-badge{width:44px;height:44px;border-radius:12px;font-size:16px}
    .prog-title{display:flex;align-items:center;gap:.4rem}
    .prog-title .name{font-size:20px;font-weight:800}

    /* сетка слотов: iPhone — 1 кол., шире — 2 кол. */
    .slots{display:grid;gap:.6rem}
    @media (min-width:560px){ .slots{grid-template-columns:1fr 1fr} }

    /* карточка слота на flex — ровные отступы */
    .slot-full{display:flex;align-items:center;justify-content:space-between;gap:.8rem}
    .slot-left{display:flex;align-items:center;gap:.6rem;min-width:0}
    .slot .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f0f3fa}
    .thumb.no{display:grid;place-items:center;color:#9cb1d9;background:#f0f3fa}
    .tnum-btn{min-width:64px;font-weight:800}
    .slot-left .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .slot-left .muted{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* quickbar под шапкой — ряд маленьких кнопок */
    .quickbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .actions-bottom{position:sticky;bottom:76px;z-index:5;background:transparent;display:flex;gap:.5rem;justify-content:space-between}
  </style>
</head>
<body data-active="programme">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Setup</div></div>
    </a>
    <div class="actions">
      <button class="btn brand sm" id="newProgTop">Neues Programm</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen"><svg><use href="./ui/icons.svg#search"/></svg></button>
    </div>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Im Setup suchen…" id="setupSearch"></div>

<main class="container">
  <!-- Программа: заголовок + Zeichnung -->
  <section class="section" id="progHeader">
    <div class="prog-title">
      <div class="name" id="progTitleText">Programm wählen…</div>
      <button class="icon-btn sm" id="editProg" aria-label="Bearbeiten"><svg><use href="./ui/icons.svg#edit"/></svg></button>
    </div>
    <div class="muted" id="progMeta">Nr — • Seite —</div>

    <div class="hero-drawing mt" id="drawingWrap" role="button" aria-label="Zeichnung wählen">
      <div class="hero-placeholder"><span class="ct-badge">CT</span><small>kein Foto</small></div>
    </div>
    <input type="file" id="drawingFile" accept="image/*" class="hidden"/>

    <!-- QUICKBAR -->
    <div class="quickbar mt">
      <button class="btn sm" id="progSwitch">Wechseln</button>
      <button class="btn ok sm" id="applyLive">In Live anwenden</button>
      <button class="btn sm" id="btnWzl">Werkzeugliste</button>
      <button class="btn sm" id="btnBackup">Backup</button>
    </div>

    <!-- Tabs RO/RU -->
    <div class="row mt">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
    </div>
  </section>

  <!-- СЕТКА СЛОТОВ -->
  <section class="section">
    <div id="slots" class="slots"></div>

    <!-- Нижние быстрые действия -->
    <div class="actions-bottom mt">
      <div class="row">
        <button class="btn" id="addToolBtn">+ Werkzeug</button>
      </div>
      <div class="row">
        <button class="btn sm" id="expSetup">Export</button>
        <button class="btn sm" id="impSetup">Import</button>
      </div>
    </div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  /* ====== Ключи и сиды ====== */
  const KEYS = (window.CT_KEYS) ? window.CT_KEYS : {
    TOOLS:'ct_tools_v2', CATS:'ct_cats_v1', SETUP:'ct_setup_live',
    PROGS:'ct_programs_v1', DASH:'ct_dash_v1', DOCS:'ct_docs_v3'
  };
  if(CT.ensureSeeds) CT.ensureSeeds();

  // валидируем live
  let live = CT.storage.read(KEYS.SETUP);
  if(!live || !Array.isArray(live.ro) || !Array.isArray(live.ru) || live.ro.length!==12 || live.ru.length!==12){
    live = {ro:Array(12).fill(null), ru:Array(12).fill(null)};
    CT.storage.write(KEYS.SETUP, live);
  }
  // гарантируем хотя бы одну программу
  let progs = CT.storage.read(KEYS.PROGS, []);
  if(!Array.isArray(progs) || !progs.length){
    progs = [{id:CT.uid(), number:'1001', title:'Grundsetup', date:Date.now(), ro:Array(12).fill(null), ru:Array(12).fill(null), drawing:null}];
    CT.storage.write(KEYS.PROGS, progs);
  }

  /* ====== state ====== */
  let side = 'ro';
  let currentProgId = progs[0]?.id || null;
  const $ = (s, r=document)=>r.querySelector(s);

  function titleOf(p){ return `${p.title||'Programm'} — ${p.number||'—'}`; }
  function sideTitle(){ return side==='ro'?'RO (G54)':'RU (G55)'; }

  /* ====== header ====== */
  function refreshHeader(){
    progs = CT.storage.read(KEYS.PROGS, []);
    const cur = progs.find(p=>p.id===currentProgId) || null;

    $('#progTitleText').textContent = cur ? titleOf(cur) : 'Programm wählen…';
    $('#progMeta').textContent = cur ? `Nr ${cur.number||'—'} • Seite ${sideTitle()}` : 'Nr — • Seite —';

    const dw = $('#drawingWrap');
    dw.innerHTML = cur?.drawing
      ? `<img src="${cur.drawing}" alt="Zeichnung">`
      : `<div class="hero-placeholder"><span class="ct-badge">CT</span><small>kein Foto</small></div>`;
  }

  /* ====== slots ====== */
  function renderSlots(){
    const root = $('#slots'); root.innerHTML='';
    const tools = CT.storage.read(KEYS.TOOLS, []);
    const data  = CT.storage.read(KEYS.SETUP, {ro:Array(12).fill(null), ru:Array(12).fill(null)})[side];

    for(let i=0;i<12;i++){
      const v = data[i];
      const el = document.createElement('div'); el.className='slot';

      if(!v){
        el.innerHTML = `<div class="slot-empty">
            <div class="muted">#${i+1} • Frei</div>
            <button class="btn" data-i="${i}">Hinzufügen</button>
          </div>`;
        el.querySelector('button').onclick=()=>selectToolFor(i);
      } else {
        const t = tools.find(x=>x.id===v.toolId);
        const label = v.tnum || `T${String(i+1).padStart(2,'0')}${String(i+1).padStart(2,'0')}`;
        el.innerHTML = `
          <div class="slot-full">
            <div class="slot-left">
              <button class="btn tnum-btn" id="tn_${i}">${label}</button>
              ${t?.imgData?`<img class="thumb" src="${t.imgData}" alt="">`:`<div class="thumb no">No</div>`}
              <div class="meta">
                <div class="name">${CT.escape(t?t.name:'—')}</div>
                <div class="muted">${CT.escape(t?t.code:'')}</div>
              </div>
            </div>
            <div class="slot-actions">
              <button class="btn ghost sm" data-i="${i}">Wechseln</button>
              <button class="btn warn sm" id="rem_${i}">Entfernen</button>
            </div>
          </div>`;
        el.querySelector('.btn.ghost').onclick=()=> selectToolFor(i);
        el.querySelector(`#rem_${i}`).onclick=()=>{ const L=CT.storage.read(KEYS.SETUP, live); L[side][i]=null; CT.storage.write(KEYS.SETUP, L); live=L; renderSlots(); };
        el.querySelector(`#tn_${i}`).onclick=()=> editTNum(i);
      }
      root.appendChild(el);
    }
  }

  /* ====== drawer/select & editors ====== */
  function openProgMenu(){
    const items = progs.map(p=>({id:p.id, title:`${p.title||'Programm'} — ${p.number||'—'}`, meta:new Date(p.date||Date.now()).toLocaleDateString()}));
    CT.openDrawer({title:'Programme', items, onSelect:(id)=>{ currentProgId=id; CT.closeDrawer(); refreshHeader(); }});
  }

  function openProgEditor(pIn){
    const p = pIn || progs.find(x=>x.id===currentProgId);
    const isNew = !p;
    const cur = p || {id:CT.uid(), number:'', title:'', date:Date.now(), ro:Array(12).fill(null), ru:Array(12).fill(null), drawing:null};
    const html = `
      <label class="fld">Titel<input id="pr_t" value="${CT.escape(cur.title)}" placeholder="Programm"></label>
      <label class="fld">Nummer<input id="pr_n" value="${CT.escape(cur.number)}" placeholder="123456"></label>
      ${!isNew?'<div class="row"><button class="btn warn" id="del">Löschen</button></div>':''}
    `;
    CT.openModal({title:isNew?'Neues Programm':'Programm bearbeiten', html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
      const up = {...cur};
      up.title  = document.getElementById('pr_t').value || 'Programm';
      up.number = document.getElementById('pr_n').value || '—';
      let arr = CT.storage.read(KEYS.PROGS, []);
      const i = arr.findIndex(x=>x.id===up.id);
      if(i>-1) arr[i]=up; else arr.push(up);
      CT.storage.write(KEYS.PROGS, arr);
      progs=arr; currentProgId=up.id; refreshHeader(); CT.toast('Gespeichert','ok');
    }});
    const del=document.getElementById('del');
    if(del) del.onclick=()=>{ progs = progs.filter(x=>x.id!==cur.id); CT.storage.write(KEYS.PROGS, progs); currentProgId=progs[0]?.id||null; CT.closeModal(); refreshHeader(); CT.toast('Gelöscht','ok'); };
  }

  function editTNum(i){
    const html = `<label class="fld">T-Nummer (Anzeige)<input id="t_num" placeholder="z.B. T0101"></label>`;
    CT.openModal({title:`Slot #${i+1}`, html, okText:'OK', onOk:()=>{
      const v=document.getElementById('t_num').value||'';
      const L=CT.storage.read(KEYS.SETUP, live);
      if(L[side][i]){ L[side][i].tnum=v; CT.storage.write(KEYS.SETUP, L); live=L; }
      const btn=document.getElementById(\`tn_\${i}\`); if(btn && v) btn.textContent=v;
      CT.toast('Aktualisiert','ok');
    }});
  }

  function selectToolFor(idx){
    const tools = CT.storage.read(KEYS.TOOLS, []);
    if(!tools.length){ return CT.toast('Keine Tools','err'); }
    const items = tools.map(t=>({id:t.id, title:t.name, meta:t.code}));
    CT.openDrawer({title:`Werkzeug wählen (#${idx+1})`, items, onSelect:(id)=>{
      const L=CT.storage.read(KEYS.SETUP, live);
      L[side][idx] = {toolId:id, note:'', tnum:`T${String(idx+1).padStart(2,'0')}${String(idx+1).padStart(2,'0')}`};
      CT.storage.write(KEYS.SETUP, L); live=L; CT.closeDrawer(); CT.toast('Aktualisiert','ok'); renderSlots();
    }});
  }

  function applyToLive(){
    const cur = CT.storage.read(KEYS.PROGS, []).find(x=>x.id===currentProgId);
    if(!cur) return;
    const L={ ro: cur.ro||Array(12).fill(null), ru: cur.ru||Array(12).fill(null) };
    CT.storage.write(KEYS.SETUP, L); live=L; CT.toast('In Live angewendet','ok'); renderSlots();
  }

  /* ====== Werkzeugliste (редактируемая) ====== */
  function openWerkzeugliste(){
    const tools = CT.storage.read(KEYS.TOOLS, []);
    const L=CT.storage.read(KEYS.SETUP, live);
    const arr=(L[side]||[]).map((cell,i)=>{
      const t = cell ? tools.find(x=>x.id===cell.toolId) : null;
      return {i:i+1, tnum:cell?.tnum||`T${String(i+1).padStart(2,'0')}${String(i+1).padStart(2,'0')}`, name:t?.name||'', code:t?.code||'', iso:t?.iso||''};
    });
    const rows = arr.map(r=>`
      <div class="row" style="gap:.4rem;margin:.2rem 0">
        <span class="badge">${r.tnum}</span>
        <input class="field" style="flex:2" data-k="name"  data-i="${r.i-1}" value="${CT.escape(r.name)}">
        <input class="field" style="flex:1" data-k="code"  data-i="${r.i-1}" value="${CT.escape(r.code)}">
        <input class="field" style="flex:1" data-k="iso"   data-i="${r.i-1}" value="${CT.escape(r.iso)}">
      </div>`).join('');
    const html = `<div class="muted">Werkzeugliste — ${sideTitle()}</div>${rows}
      <div class="row mt"><button class="btn sm" id="printWZL">Drucken / PDF</button></div>`;
    CT.openModal({title:'Werkzeugliste', html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
      // сохраняем только подписи (в Tools не лезем)
      CT.toast('Gespeichert','ok');
    }});
    document.getElementById('printWZL').onclick=()=>{ window.print(); };
  }

  /* ====== Backup/Export/Import ====== */
  function doBackup(){
    const dump = {
      tools:CT.storage.read(KEYS.TOOLS,[]),
      cats: CT.storage.read(KEYS.CATS,[]),
      progs:CT.storage.read(KEYS.PROGS,[]),
      setup:CT.storage.read(KEYS.SETUP,{ro:[],ru:[]}),
      docs: CT.storage.read(KEYS.DOCS,[]),
      dash: CT.storage.read(KEYS.DASH,[])
    };
    CT.exportJSON('citi_backup.json', dump);
  }
  function exportSetup(){
    const L=CT.storage.read(KEYS.SETUP, live);
    CT.exportJSON(`setup_${side}.json`, L[side]||[]);
  }
  function importSetup(){
    CT.importJSON().then(arr=>{
      if(!Array.isArray(arr)){ return CT.toast('Falsches Format','err'); }
      const L=CT.storage.read(KEYS.SETUP, live); L[side]=arr.slice(0,12); CT.storage.write(KEYS.SETUP, L); live=L; CT.toast('Importiert','ok'); renderSlots();
    });
  }

  /* ====== события UI ====== */
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); side=b.dataset.side; refreshHeader(); renderSlots();});
  document.getElementById('progSwitch').onclick = openProgMenu;
  document.getElementById('applyLive').onclick = applyToLive;
  document.getElementById('editProg').onclick = ()=>openProgEditor();
  document.getElementById('newProgTop').onclick = ()=>openProgEditor(null);

  document.getElementById('btnWzl').onclick = openWerkzeugliste;
  document.getElementById('btnBackup').onclick = doBackup;
  document.getElementById('expSetup').onclick = exportSetup;
  document.getElementById('impSetup').onclick = importSetup;
  document.getElementById('addToolBtn').onclick = ()=> selectToolFor( (CT.storage.read(KEYS.SETUP, live)[side].findIndex(x=>x===null))>=0 ? CT.storage.read(KEYS.SETUP, live)[side].findIndex(x=>x===null) : 0 );

  // Zeichnung выбор по клику
  document.getElementById('drawingWrap').onclick = ()=> document.getElementById('drawingFile').click();
  document.getElementById('drawingFile').onchange = ()=>{
    const f = document.getElementById('drawingFile').files?.[0]; if(!f) return;
    CT.readFileAsDataURL(f).then(data=>{
      const arr = CT.storage.read(KEYS.PROGS, []);
      const cur = arr.find(p=>p.id===currentProgId); if(!cur) return CT.toast('Programm fehlt','err');
      cur.drawing = data; CT.storage.write(KEYS.PROGS, arr); refreshHeader(); CT.toast('Zeichnung gespeichert','ok');
    });
  };

  refreshHeader(); renderSlots();
});
</script>
</body>
</html>