<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Setup</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    .hero-drawing{display:grid;place-items:center;width:100%;height:180px;border:1px dashed #dfe6f7;border-radius:14px;background:#fafcff;overflow:hidden}
    .hero-drawing img{width:100%;height:100%;object-fit:contain}
    .hero-placeholder{display:grid;place-items:center;gap:.4rem;color:#8aa0c5}
    .hero-placeholder .ct-badge{width:40px;height:40px;border-radius:12px;font-size:16px}
    .prog-title{display:flex;align-items:center;gap:.35rem}
    .prog-title .name{font-size:20px;font-weight:800}
    .slot .name{font-weight:800}
  </style>
</head>
<body data-active="programme">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Setup</div></div>
    </a>
    <div class="actions">
      <button class="btn brand sm" id="newProgTop">Neues Programm</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen"><svg><use href="./ui/icons.svg#search"/></svg></button>
    </div>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Im Setup suchen…" id="setupSearch"></div>

<main class="container">
  <section class="section" id="progHeader">
    <div class="prog-title">
      <div class="name" id="progTitleText">Programm wählen…</div>
      <button class="icon-btn sm info" id="editProg"><svg><use href="./ui/icons.svg#edit"/></svg></button>
    </div>
    <div class="muted" id="progMeta">Nr — • Seite —</div>

    <div class="hero-drawing mt" id="drawingWrap">
      <div class="hero-placeholder"><span class="ct-badge">CT</span><small>kein Foto</small></div>
    </div>
    <input type="file" id="drawingFile" accept="image/*" class="hidden"/>

    <div class="row mt">
      <button class="tab active" data-side="ro">RO (G54)</button>
      <button class="tab" data-side="ru">RU (G55)</button>
      <span style="flex:1"></span>
      <button class="btn" id="progSwitch">Wechseln</button>
      <button class="btn brand" id="newProg">Neues Programm</button>
      <button class="btn ok" id="applyLive">In Live anwenden</button>
    </div>
  </section>

  <section class="section">
    <div id="slots" class="slots"></div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  // Проверка наличия структуры live
  CT.ensureSeeds();
  let live = CT.storage.read(CT.CT_KEYS.SETUP);
  if(!live || !Array.isArray(live.ro) || !Array.isArray(live.ru)){
    live = {ro:Array(12).fill(null), ru:Array(12).fill(null)};
    CT.storage.write(CT.CT_KEYS.SETUP, live);
  }

  let progs = CT.storage.read(CT.CT_KEYS.PROGS, []);
  let side  = 'ro';
  let currentProgId = progs[0]?.id || null;
  const $ = (s, r=document)=>r.querySelector(s);

  function refreshHeader(){
    progs = CT.storage.read(CT.CT_KEYS.PROGS, []);
    const cur = progs.find(p=>p.id===currentProgId) || null;
    $('#progTitleText').textContent = cur ? `${cur.number||'—'} – ${cur.title||'Programm'}` : 'Programm wählen…';
    $('#progMeta').textContent = cur ? `Nr ${cur.number||'—'} • Seite ${side==='ro'?'RO (G54)':'RU (G55)'}` : '';
    const dw = $('#drawingWrap');
    dw.innerHTML = cur?.drawing
      ? `<img src="${cur.drawing}" alt="Zeichnung">`
      : `<div class="hero-placeholder"><span class="ct-badge">CT</span><small>kein Foto</small></div>`;
  }

  function renderSlots(){
    const root=$('#slots'); root.innerHTML='';
    const tools = CT.storage.read(CT.CT_KEYS.TOOLS, []);
    const data = live[side] || Array(12).fill(null);

    for(let i=0;i<12;i++){
      const v = data[i];
      const el = document.createElement('div'); el.className='slot';
      if(!v){
        el.innerHTML = `<div class="slot-empty"><div class="muted">#${i+1} • Frei</div>
          <button class="btn" data-i="${i}">Hinzufügen</button></div>`;
        el.querySelector('button').onclick=()=>selectTool(i);
      }else{
        const t = tools.find(x=>x.id===v.toolId);
        el.innerHTML = `
          <div class="slot-full">
            <button class="btn tnum-btn">${v.tnum||('T'+String(i+1).padStart(2,'0')+String(i+1).padStart(2,'0'))}</button>
            ${t?.imgData?`<img class="thumb" src="${t.imgData}" alt="">`:`<div class="thumb" style="display:grid;place-items:center;color:#9cb1d9">No</div>`}
            <div><div class="name">${t?t.name:'—'}</div><div class="muted">${t?t.code:''}</div></div>
            <div class="tail"><button class="btn ghost sm" data-i="${i}">Wechseln</button>
              <button class="btn warn sm" id="rem_${i}">Entfernen</button></div>
          </div>`;
        el.querySelector('.btn.ghost').onclick=()=>selectTool(i);
        el.querySelector(`#rem_${i}`).onclick=()=>{live[side][i]=null;CT.storage.write(CT.CT_KEYS.SETUP,live);renderSlots();};
      }
      root.appendChild(el);
    }
  }

  function selectTool(i){
    const tools=CT.storage.read(CT.CT_KEYS.TOOLS,[]);
    if(!tools.length)return CT.toast('Keine Tools','err');
    const items=tools.map(t=>({id:t.id,title:t.name,meta:t.code}));
    CT.openDrawer({title:`Werkzeug wählen (#${i+1})`,items,onSelect:(id)=>{
      live[side][i]={toolId:id,tnum:`T${String(i+1).padStart(2,'0')}${String(i+1).padStart(2,'0')}`};
      CT.storage.write(CT.CT_KEYS.SETUP,live);
      CT.toast('Gespeichert','ok');CT.closeDrawer();renderSlots();
    }});
  }

  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');side=b.dataset.side;refreshHeader();renderSlots();});
  document.getElementById('drawingWrap').onclick=()=>$('#drawingFile').click();
  document.getElementById('drawingFile').onchange=()=>{
    const f=$('#drawingFile').files?.[0];if(!f)return;
    CT.readFileAsDataURL(f).then(d=>{
      const progs=CT.storage.read(CT.CT_KEYS.PROGS,[]);
      const cur=progs.find(p=>p.id===currentProgId);if(!cur)return CT.toast('Programm fehlt','err');
      cur.drawing=d;CT.storage.write(CT.CT_KEYS.PROGS,progs);refreshHeader();
    });
  };

  refreshHeader();
  renderSlots();
});
</script>
</body>
</html>