<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();

  const SKEY = CT_KEYS;
  let progs = CT.storage.read(SKEY.PROGS, []);
  let live  = CT.storage.read(SKEY.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
  let side  = 'ro';
  let currentProgId = progs[0]?.id || null;

  // DOM
  const elTitle = document.getElementById('progTitle');
  const elNum   = document.getElementById('progNumber');
  const elThumb = document.getElementById('thumbBtn');
  const slots   = document.getElementById('slots');

  // helpers
  const pad2 = n=>String(n).padStart(2,'0');
  const defT = i=>`T${pad2(i+1)}${pad2(i+1)}`;
  const curProg = ()=> progs.find(p=>p.id===currentProgId)||null;

  // ===== Programme header =====
  function renderProgramme(){
    progs = CT.storage.read(SKEY.PROGS, []);
    const p = curProg();
    if(!p){
      elTitle.textContent='Programm wählen…';
      elNum.textContent='# —';
      elThumb.textContent='no foto'; elThumb.innerHTML='no foto';
      return;
    }
    elTitle.textContent = p.title || 'Programm';
    elNum.textContent   = `#${p.number||'—'}`;
    elThumb.innerHTML   = p.drawingData ? `<img src="${p.drawingData}" alt="" style="height:44px;border-radius:8px">` : 'no foto';
  }

  // ===== Programme drawer =====
  function openChoose(){
    const items = progs.map(p=>({id:p.id, title:`#${p.number} — ${p.title}`, meta:new Date(p.date).toLocaleDateString()}));
    if(!items.length){ CT.toast('Keine Programme','err'); return; }
    CT.openDrawer({title:'Programme', items, onSelect:(id)=>{ currentProgId=id; CT.closeDrawer(); renderProgramme(); renderSlots(); }});
  }

  // ===== Programme editor (только CT.openModal) =====
  async function openEditor(p, isNew){
    const imgBlock = p.drawingData
      ? `<div class="imgwrap"><img src="${p.drawingData}" alt=""></div>`
      : `<div class="imgwrap"><div style="width:100%;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`;

    const html = `
      ${imgBlock}
      <div class="row">
        <label class="btn sm" for="pr_file" style="cursor:pointer">Zeichnung anhängen</label>
        ${p.drawingData?'<button class="btn sm warn" id="btnRemove">Entfernen</button>':''}
      </div>
      <input id="pr_file" type="file" accept="image/*,application/pdf" style="display:none">
      <div class="muted" id="fileInfo">${p.drawingName?CT.escape('Angehängt: '+p.drawingName):'Keine Zeichnung'}</div>

      <label class="fld" style="margin-top:.5rem">Titel<input id="pr_t" value="${CT.escape(p.title||'')}" placeholder="Programmname"></label>
      <label class="fld">Nummer<input id="pr_n" inputmode="numeric" pattern="[0-9]*" value="${CT.escape(p.number||'')}" placeholder="z.B. 1234"></label>

      ${!isNew?'<div class="row mt"><button class="btn warn" id="doDelete">Löschen</button></div>':''}
    `;

    CT.openModal({
      title: isNew?'Neues Programm':'Programm',
      html,
      okText:'Speichern',
      cancelText:'Schließen',
      onOk: async ()=>{
        // собрать значения при нажатии OK
        const up = {...p};
        up.title  = (document.getElementById('pr_t').value||'').trim() || 'Programm';
        up.number = (document.getElementById('pr_n').value||'').trim() || up.number || 1000;

        const f    = document.getElementById('pr_file')?.files?.[0];
        const rmEl = document.getElementById('btnRemove');
        const removed = rmEl && rmEl.dataset._rm === '1';

        if(f){
          up.drawingName = f.name;
          up.drawingData = await CT.readFileAsDataURL(f);
        }else if(removed){
          up.drawingName = '';
          up.drawingData = '';
        }

        if(isNew) progs.push(up); else progs = progs.map(x=>x.id===up.id?up:x);
        CT.storage.write(SKEY.PROGS, progs);
        currentProgId = up.id;
        renderProgramme();
        CT.toast('Gespeichert','ok');
      }
    });

    // бинды внутри уже открытой модалки
    setTimeout(()=>{
      const file = document.getElementById('pr_file');
      if(file) file.onchange = ()=>{ const f=file.files?.[0]; if(f) document.getElementById('fileInfo').textContent='Ausgewählt: '+f.name; };

      const rm = document.getElementById('btnRemove');
      if(rm) rm.onclick = ()=>{ rm.dataset._rm = '1'; document.getElementById('fileInfo').textContent='Keine Zeichnung'; };

      const del = document.getElementById('doDelete');
      if(del) del.onclick = ()=>{
        progs = progs.filter(x=>x.id!==p.id);
        CT.storage.write(SKEY.PROGS, progs);
        currentProgId = progs[0]?.id || null;
        CT.closeModal(); renderProgramme(); renderSlots(); CT.toast('Gelöscht','ok');
      };

      const t = document.getElementById('pr_t'); if(t) t.focus();
    },0);
  }

  // ===== Setup (Live) =====
  function renderSlots(){
    live = CT.storage.read(SKEY.SETUP, live);
    const tools = CT.storage.read(SKEY.TOOLS, []);
    const q = (document.getElementById('setupSearch')?.value||'').toLowerCase();
    slots.innerHTML='';
    for(let i=0;i<12;i++){
      const v = live[side][i];
      const tnum = (v&&v.tnum) ? v.tnum : defT(i);
      const wrap = document.createElement('div'); wrap.className='slot';
      if(!v){
        wrap.innerHTML = `
          <div class="slot-full" style="display:grid;grid-template-columns:72px 56px 1fr auto;gap:.6rem;align-items:center">
            <span class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</span>
            <div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>
            <div class="meta"><div class="name"><b>#${i+1} • Leer</b></div><div class="sub">—</div></div>
            <div class="tail"><button class="btn sm" data-add="${i}">Hinzufügen</button></div>
          </div>`;
      }else{
        const t = tools.find(x=>x.id===v.toolId);
        const name = t ? t.name : '—';
        const code = t ? t.code : '';
        if(q && !(name.toLowerCase().includes(q)||code.toLowerCase().includes(q))) { continue; }
        const thumb = t?.imgData
          ? `<img class="thumb" src="${t.imgData}" style="width:56px;height:56px;object-fit:cover;border-radius:10px;background:#f0f3fa">`
          : `<div class="thumb" style="width:56px;height:56px;border-radius:10px;background:#eef3ff;display:grid;place-items:center;color:#9cb1d9;font-weight:700">no foto</div>`;
        wrap.innerHTML = `
          <div class="slot-full" style="display:grid;grid-template-columns:72px 56px 1fr auto;gap:.6rem;align-items:center">
            <span class="badge tnum-btn" data-tnum="${i}">${CT.escape(tnum)}</span>
            ${thumb}
            <div class="meta"><div class="name"><b>${CT.escape(name)}</b></div><div class="sub">${CT.escape(code)}</div></div>
            <div class="tail" style="display:flex;gap:.25rem">
              <button class="icon-btn info" data-info="${i}"><svg><use href="./ui/icons.svg#info"/></svg></button>
              <button class="icon-btn" data-change="${i}"><svg><use href="./ui/icons.svg#edit"/></svg></button>
            </div>
          </div>`;
      }
      slots.appendChild(wrap);
    }
    // bind actions
    slots.querySelectorAll('[data-add]').forEach(b=>b.onclick=()=>selectToolFor(+b.dataset.add));
    slots.querySelectorAll('[data-change]').forEach(b=>b.onclick=()=>selectToolFor(+b.dataset.change, true));
    slots.querySelectorAll('[data-info]').forEach(b=>b.onclick=()=>slotInfo(+b.dataset.info));
    slots.querySelectorAll('[data-tnum]').forEach(b=>b.onclick=()=>editTnum(+b.dataset.tnum));
  }

  function selectToolFor(idx, cycle=false){
    const tools = CT.storage.read(SKEY.TOOLS, []);
    if(!tools.length){ CT.toast('Keine Werkzeuge','err'); return; }
    if(cycle){
      const cur = live[side][idx]?.toolId;
      const i = tools.findIndex(t=>t.id===cur);
      const next = (i>=0 && i<tools.length-1) ? i+1 : 0;
      const prev = live[side][idx] || {};
      live[side][idx] = { toolId:tools[next].id, tnum:(prev.tnum||defT(idx)) };
      CT.storage.write(SKEY.SETUP, live); renderSlots(); return;
    }
    const items = tools.map(t=>({id:t.id, title:t.name, meta:t.code}));
    CT.openDrawer({title:`Werkzeug wählen (#${idx+1})`, items, onSelect:(id)=>{
      const prev = live[side][idx] || {};
      live[side][idx] = { toolId:id, tnum:(prev.tnum||defT(idx)) };
      CT.storage.write(SKEY.SETUP, live); CT.closeDrawer(); CT.toast('Aktualisiert','ok'); renderSlots();
    }});
  }

  function slotInfo(i){
    const t = CT.getToolFromSlot(live, side, i);
    if(!t){ CT.toast('Kein Werkzeug','err'); return; }
    const html = `
      ${t.imgData?`<div class="imgwrap"><img src="${t.imgData}" alt=""></div>`:
        `<div class="imgwrap"><div style="width:100%;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`}
      <b>${CT.escape(t.name)}</b><div class="i-row">${CT.escape(t.code)}</div>
      <div class="row"><button class="btn warn" id="btnRem">Entfernen</button></div>`;
    CT.openModal({title:`Position #${i+1}`, html, cancelText:'Schließen'});
    setTimeout(()=>{ const r=document.getElementById('btnRem'); if(r) r.onclick=()=>{ live[side][i]=null; CT.storage.write(SKEY.SETUP, live); CT.closeModal(); renderSlots(); }; },0);
  }

  function editTnum(i){
    const v = live[side][i] || {};
    const cur = v.tnum || defT(i);
    const html = `<label class="fld">Nummer<input id="_tn" value="${CT.escape(cur)}"></label>`;
    CT.openModal({title:`Nummer #${i+1}`, html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
      const val = (document.getElementById('_tn').value||cur).trim()||cur;
      const cell = live[side][i] || {};
      cell.tnum = val; live[side][i]=cell;
      CT.storage.write(SKEY.SETUP, live); CT.toast('Gespeichert','ok'); renderSlots();
    }});
  }

  // ===== Binds =====
  document.getElementById('btnChoose').onclick = openChoose;
  document.getElementById('btnNew').onclick = ()=>{
    const p = { id:CT.uid(), number:1000+Math.floor(Math.random()*9000), title:'Neues Programm', date:Date.now(),
                ro:Array(12).fill(null), ru:Array(12).fill(null), drawingName:'', drawingData:'' };
    openEditor(p, true);
  };
  document.getElementById('btnEdit').onclick = ()=>{ const p=curProg(); if(p) openEditor(p,false); else CT.toast('Kein Programm','err'); };
  elTitle.onclick = ()=>{ const p=curProg(); if(!p) openChoose(); else openEditor(p,false); };
  elThumb.onclick = ()=>{ const p=curProg(); if(p) openEditor(p,false); };

  document.querySelectorAll('.tab').forEach(b=>{
    b.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); side=b.dataset.side; renderSlots(); };
  });

  document.getElementById('applyLive').onclick = ()=>{
    const p = curProg(); if(!p) return;
    live = { ro:(p.ro||Array(12).fill(null)), ru:(p.ru||Array(12).fill(null)) };
    CT.storage.write(SKEY.SETUP, live); CT.toast('In Live angewendet','ok'); renderSlots();
  };

  document.getElementById('setupSearch')?.addEventListener('input', renderSlots);
  CT.bindGlobalSearch(()=>renderSlots());

  // init
  renderProgramme();
  renderSlots();
});
</script>