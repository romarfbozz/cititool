<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Lernmodul</title>
  <link rel="stylesheet" href="./ui/core.css">
</head>
<body data-active="docs">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <img src="./ui/brand.png" alt="CT" class="badge">
      <div class="tit">
        <div class="title">CitiTool</div>
        <div class="subtitle">Lernmodul</div>
      </div>
    </a>
    <div class="actions">
      <button class="btn ghost sm" id="aiAskBtn">AI-Assistent</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
        <svg><use href="./ui/icons.svg#search"/></svg>
      </button>
    </div>
  </div>
</header>

<div class="searchbar collapsed">
  <input class="field" type="search" placeholder="Themen / Dateien suchen…" id="lernSearch">
</div>

<main class="container">
  <section class="section">
    <h2>Programmieren & Referenz</h2>
    <ul id="docList" class="cards"></ul>
  </section>

  <section class="section">
    <h2>Hinweis</h2>
    <div class="card">
      <div class="row">
        <div class="muted">
          PDFs öffnen sich в окне просмотра. DOC/PPT — скачиваются (предпросмотр зависит от браузера).<br>
          Нужна помощь? Нажми <b>AI-Assistent</b> и спроси, например: <i>„Erkläre VERSCHIEBUNG Unterprogramm“</i>.
        </div>
      </div>
    </div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script src="./ui/ai.js"></script>
<script>
CT.ready(()=>{
  // 1) Регистрируем материалы учебника (можно расширять)
  const DOCS = [
    {id:CT.uid(), title:'M-Funktionsliste', type:'pdf', path:'./ai/docs/M-Funktionsliste.pdf', tags:['M','Referenz']},
    {id:CT.uid(), title:'Unterprogramm VERSCHIEBUNG', type:'doc', path:'./ai/docs/Unterprogramm VERSCHIEBUNG.doc', tags:['Subprogramm','Verschiebung']},
    {id:CT.uid(), title:'Arbeitsplan (ohne B-Achse, ohne Pinole)', type:'doc', path:'./ai/docs/Arbeitspl ohne B-Achse ohne Pinole.doc', tags:['Arbeitsplan']},
    {id:CT.uid(), title:'Schlittenspindelzuordnung GMX', type:'ppt', path:'./ai/docs/03_Schlittenspindelzuordnung_GMX.ppt', tags:['GMX','Spindel']},
    {id:CT.uid(), title:'Möglichkeiten der Programmierung', type:'ppt', path:'./ai/docs/02_Möglichketen der Programmierung.ppt', tags:['Programmierung']},
    {id:CT.uid(), title:'Anfahren der Werkzeugwechselpunkte', type:'ppt', path:'./ai/docs/05_Anfahren der Werkzeugwechselpunkte.ppt', tags:['Werkzeugwechselpunkte']},
    {id:CT.uid(), title:'L1000 (Kapitel 04)', type:'ppt', path:'./ai/docs/04_L1000.ppt', tags:['L1000']},
    {id:CT.uid(), title:'A-D215DE-1', type:'pdf', path:'./ai/docs/A-D215DE-1.pdf', tags:['DMG']},
    {id:CT.uid(), title:'A-D215DE-1PN', type:'pdf', path:'./ai/docs/A-D215DE-1PN.pdf', tags:['DMG']},
    {id:CT.uid(), title:'Dummy Präsentation', type:'ppt', path:'./ai/docs/081208_DUMMY.ppt', tags:['Demo']}
  ];

  // Сохраняем лёгкий индекс для ИИ
  CT.storage.write('ct_lern_index', DOCS.map(d=>({title:d.title, type:d.type, path:d.path, tags:d.tags||[]})));

  // 2) Рендер списка
  const listEl = document.getElementById('docList');
  function badgeFor(type){
    const map = {pdf:'PDF', doc:'DOC', ppt:'PPT'};
    return `<span class="badge">${map[type]||type.toUpperCase()}</span>`;
  }
  function openDoc(d){
    if(d.type==='pdf'){
      const html = `
        <div class="i-row">${badgeFor(d.type)} • ${CT.escape(d.path.split('/').pop())}</div>
        <div class="imgwrap" style="margin:.25rem 0">
          <iframe src="${d.path}" style="width:100%;height:60vh;border:1px solid #e6edf8;border-radius:12px"></iframe>
        </div>
        <div class="row">
          <button class="btn brand" id="aiExplain">Mit AI erklären</button>
          <a class="btn" href="${d.path}" download>Download</a>
        </div>`;
      CT.openModal({title:d.title, html, cancelText:'Schließen'});
      document.getElementById('aiExplain').onclick=()=>CT.ai.ask(`Erkläre kurz den Inhalt: ${d.title}`, {path:d.path, type:d.type});
    }else{
      const html = `
        <div class="i-row">${badgeFor(d.type)} • ${CT.escape(d.path.split('/').pop())}</div>
        <div class="muted">Vorschau für ${d.type.toUpperCase()} ist ggf. begrenzt. Du kannst die Datei herunterladen oder AI um Erklärung bitten.</div>
        <div class="row">
          <button class="btn brand" id="aiExplain">Mit AI erklären</button>
          <a class="btn" href="${d.path}" download>Download</a>
        </div>`;
      CT.openModal({title:d.title, html, cancelText:'Schließen'});
      document.getElementById('aiExplain').onclick=()=>CT.ai.ask(`Erkläre Datei: ${d.title}`, {path:d.path, type:d.type});
    }
  }
  function render(){
    const q=(document.getElementById('lernSearch').value||'').toLowerCase();
    listEl.innerHTML='';
    const data = DOCS.filter(d=>{
      const hay = (d.title+' '+(d.tags||[]).join(' ')+d.type).toLowerCase();
      return !q || hay.includes(q);
    });
    if(!data.length){ listEl.innerHTML = '<li class="muted">Nichts gefunden</li>'; return; }
    data.forEach(d=>{
      const li=document.createElement('li'); li.className='card note';
      li.innerHTML=`
        <img class="thumb" src="./ui/nofoto.png" alt="" onerror="this.style.opacity=.3">
        <div class="meta">
          <div class="name" style="font-weight:800">${CT.escape(d.title)}</div>
          <div class="sub">${badgeFor(d.type)} • ${(d.tags||[]).map(t=>`#${CT.escape(t)}`).join(' ')}</div>
        </div>
        <div class="tail">
          <button class="btn sm" data-act="open">Öffnen</button>
          <button class="btn brand sm" data-act="ai">AI</button>
        </div>`;
      li.querySelector('[data-act="open"]').onclick=()=>openDoc(d);
      li.querySelector('[data-act="ai"]').onclick =()=>CT.ai.ask(`Erkläre Thema: ${d.title}`, {path:d.path, type:d.type});
      listEl.appendChild(li);
    });
  }

  // 3) Handlers
  document.getElementById('aiAskBtn').onclick=()=>{
    CT.ai.ask('Ich brauche Hilfe beim Lernmodul. Welche Themen gibt es und womit anfangen?', {});
  };
  document.getElementById('lernSearch').addEventListener('input', render);
  CT.bindGlobalSearch(()=>render());

  // 4) Старт
  CT.ensureSeeds(); // не мешает — просто гарантирует базовые демо-данные в LS
  render();
});
</script>
</body>
</html>
