
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Werkzeugs­chrank</title>
  <link rel="stylesheet" href="./ui/core.css">
</head>
<body data-active="tools">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Werkzeugs­chrank</div></div>
    </a>
    <div class="actions">
      <button class="btn ghost sm" id="btnCats">Kategorien</button>
      <button class="btn brand sm" id="btnNew">Neu</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen"><svg><use href="./ui/icons.svg#search"/></svg></button>
    </div>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Werkzeuge suchen…" id="toolSearch"></div>

<main class="container">
  <section class="section">
    <h2>Liste</h2>
    <ul id="toolList" class="list-tools"></ul>
  </section>
</main>
<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();
  let tools = CT.storage.read(CT_KEYS.TOOLS, []);
  let cats  = CT.storage.read(CT_KEYS.CATS, []);
  let activeCat = 'ALL';

  // robust: принимает id ИЛИ объект, возвращает название категории
  function catTitle(ref){
    const id = (ref && typeof ref==='object') ? ref.id : ref;
    if(id==='ALL') return 'Alle';
    const c = (cats||[]).find(x=>x.id===id);
    return c ? c.title : '—';
  }

  function render(){
    tools = CT.storage.read(CT_KEYS.TOOLS, []);
    cats  = CT.storage.read(CT_KEYS.CATS, []);
    const ul = document.getElementById('toolList'); ul.innerHTML='';
    const q = (document.getElementById('toolSearch').value||'').trim().toLowerCase();

    const data = tools.filter(t => (activeCat==='ALL'||((t.catId&&t.catId.id)||t.catId)===activeCat) &&
      (t.name.toLowerCase().includes(q)||t.code.toLowerCase().includes(q)||(t.iso||'').toLowerCase().includes(q)));

    if(!data.length){ ul.innerHTML = '<li class="muted">Keine Werkzeuge</li>'; return; }

    data.forEach(t=>{
      const li = document.createElement('li');

      // thumb: фиксированный размер, placeholder если нет фото
      const thumbHTML = t.imgData
        ? `<img class="thumb" src="${t.imgData}" alt="">`
        : `<div class="thumb" style="display:grid;place-items:center;background:#eef3ff;color:#9cb1d9;font-weight:700">no foto</div>`;

      li.innerHTML = `
        ${thumbHTML}
        <div class="meta">
          <div class="name"><b>${CT.escape(t.name)}</b></div>
          <div class="sub">${CT.escape(t.code)} • ${CT.escape(catTitle(t.catId))}</div>
        </div>
        <div class="tail">
          <button class="icon-btn info" aria-label="Info"><svg><use href="./ui/icons.svg#info"/></svg></button>
        </div>`;

      li.querySelector('button').onclick=()=>showInfo(t);
      ul.appendChild(li);
    });
  }

  function showInfo(t){
    const cat = catTitle(t.catId);
    const big = t.imgData
      ? `<div class="imgwrap"><img src="${t.imgData}" alt="" style="max-height:40vh;object-fit:contain"></div>`
      : `<div class="imgwrap"><div style="width:92vw;max-width:520px;aspect-ratio:4/3;display:grid;place-items:center;background:#eef3ff;border-radius:14px;color:#9cb1d9;font-weight:700">no foto</div></div>`;

    const html = `
      ${big}
      <div class="i-head"><b>${CT.escape(t.name)}</b></div>
      <div class="i-row">${CT.escape(t.code)} • ${CT.escape(cat)} • ${CT.escape(t.maker||'')}</div>
      <div class="i-grid">
        <div><label>ISO</label><div>${CT.escape(t.iso||'—')}</div></div>
        <div class="full"><label>Notiz</label><div>${CT.escape(t.note||'')}</div></div>
      </div>
      <div class="row">
        <button class="btn" id="toSetup">+ Zu Setup</button>
        <button class="btn brand" id="edit">Bearbeiten</button>
      </div>`;
    CT.openModal({title:'Werkzeug', html, cancelText:'Schließen'});
    document.getElementById('edit').onclick=()=>editTool(t);
    document.getElementById('toSetup').onclick=()=>assignToSetup(t);
  }

  function editTool(t){
    const isNew = !t;
    // нормализуем catId к строке id
    const cur = t ? {...t, catId: (t.catId && typeof t.catId==='object')? t.catId.id : t.catId }
                  : {id:CT.uid(), name:'', code:'', catId:cats[0]?.id, iso:'', maker:'', note:'', imgData:''};
    const catOptions = (cats||[]).map(c=>`<option value="${c.id}" ${c.id===cur.catId?'selected':''}>${CT.escape(c.title)}</option>`).join('');
    const html = `
      <label class="fld">Name<input id="f_name" value="${CT.escape(cur.name)}" placeholder="Bezeichnung"></label>
      <label class="fld">Code<input id="f_code" value="${CT.escape(cur.code)}" placeholder="Artikel/Code"></label>
      <label class="fld">Kategorie
        <div style="display:flex;gap:.4rem">
          <select id="f_cat" style="flex:1">${catOptions}</select>
          <button class="btn sm" id="newCatBtn" type="button">+ neu</button>
        </div>
      </label>
      <label class="fld">ISO<input id="f_iso" value="${CT.escape(cur.iso)}" placeholder="z.B. CNMG120408-PM"></label>
      <label class="fld">Hersteller<input id="f_maker" value="${CT.escape(cur.maker)}"></label>
      <label class="fld">Notiz<textarea id="f_note" rows="3">${CT.escape(cur.note||'')}</textarea></label>
      <label class="fld file">Foto<input id="f_img" type="file" accept="image/*"></label>
      ${!isNew?'<div class="row"><button class="btn warn" id="del">Löschen</button></div>':''}
    `;
    CT.openModal({title:isNew?'Neues Werkzeug':'Werkzeug bearbeiten', html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
      const up = {...cur};
      up.name=document.getElementById('f_name').value||'Werkzeug';
      up.code=document.getElementById('f_code').value||'—';
      up.catId=String(document.getElementById('f_cat').value||'');
      up.iso=document.getElementById('f_iso').value;
      up.maker=document.getElementById('f_maker').value;
      up.note=document.getElementById('f_note').value;
      const file=document.getElementById('f_img').files?.[0];
      const commit=()=>{ const arr=CT.storage.read(CT_KEYS.TOOLS,[]); const idx=arr.findIndex(x=>x.id===up.id);
        if(idx>-1) arr[idx]=up; else arr.push(up); CT.storage.write(CT_KEYS.TOOLS,arr); CT.toast('Gespeichert','ok'); render(); };
      if(file){ CT.readFileAsDataURL(file).then(data=>{up.imgData=data; commit();}); } else commit();
    }});
    // inline "+ neu" для категории
    document.getElementById('newCatBtn').onclick=()=>createCategoryInline();

    const delBtn=document.getElementById('del');
    if(delBtn) delBtn.onclick=()=>{
      const arr=CT.storage.read(CT_KEYS.TOOLS,[]).filter(x=>x.id!==cur.id);
      CT.storage.write(CT_KEYS.TOOLS,arr); CT.closeModal(); render(); CT.toast('Gelöscht','ok');
    };
  }

  function createCategoryInline(){
    CT.openModal({
      title:'Neue Kategorie',
      html:`<label class="fld">Titel<input id="cat_title" placeholder="z.B. Halter"></label>`,
      okText:'Anlegen',
      cancelText:'Abbrechen',
      onOk:()=>{
        const title=(document.getElementById('cat_title').value||'').trim();
        if(!title){ CT.toast('Titel leer','err'); return; }
        const list=CT.storage.read(CT_KEYS.CATS,[]);
        const exists=list.some(c=>String(c.title).toLowerCase()===title.toLowerCase());
        if(exists){ CT.toast('Schon vorhanden','err'); return; }
        const id=CT.uid(); list.push({id,title}); CT.storage.write(CT_KEYS.CATS,list);
        CT.closeModal(); cats=list; render(); CT.toast('Kategorie erstellt','ok');
      }
    });
  }

  function assignToSetup(tool){
    const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
    const options = ['ro','ru'].map(side=>{
      const label = side==='ro'?'RO (G54)':'RU (G55)';
      const slots = Array.from({length:12},(_,i)=> {
        const busy = !!live[side][i];
        return `<button class="btn ${busy?'ghost':''}" data-side="${side}" data-slot="${i}" ${busy?'disabled':''}>${i+1}</button>`;
      }).join('');
      return `<div class="drawer-block"><div class="hdr">${label}</div><div class="row">${slots}</div></div>`;
    }).join('');
    CT.openDrawer({title:'Zu Setup zuweisen', html:options});
    document.querySelectorAll('.drawer .btn').forEach(b=>{
      b.onclick=()=>{
        const side=b.dataset.side, slot=+b.dataset.slot;
        const data=CT.storage.read(CT_KEYS.SETUP,{ro:Array(12).fill(null), ru:Array(12).fill(null)});
        data[side][slot]={toolId:tool.id, note:''}; CT.storage.write(CT_KEYS.SETUP,data);
        CT.closeDrawer(); CT.toast(`Zugewiesen: ${side.toUpperCase()} #${slot+1}`,'ok');
      };
    });
  }

  // Kategorien Drawer (просмотр/фильтр + добавить/удалить пустые)
  document.getElementById('btnCats').onclick=()=>{
    const counts = (id)=>CT.storage.read(CT_KEYS.TOOLS,[]).filter(t=>((t.catId&&t.catId.id)||t.catId)===id).length;
    const list = (cats||[]).map(c=>{
      const n=counts(c.id);
      return `<li data-id="${c.id}">
        <div><b>${CT.escape(c.title)}</b><div class="muted">${n} Stück</div></div>
        <div class="row">
          <button class="btn sm ${activeCat===c.id?'ok':''}" data-act="filter">Öffnen</button>
          <button class="btn sm warn" data-act="del" ${n? 'disabled':''}>Löschen</button>
        </div>
      </li>`;
    }).join('');
    const html = `
      <div class="row" style="margin-bottom:.5rem">
        <button class="btn sm ${activeCat==='ALL'?'ok':''}" data-act="all">Alle</button>
        <button class="btn sm" data-act="new">+ Neue Kategorie</button>
      </div>
      <ul class="list">${list || '<li class="muted">Keine Kategorien</li>'}</ul>
    `;
    CT.openDrawer({title:'Kategorien', html});
    const drawer=document.querySelector('.drawer');

    // handlers
    drawer.querySelector('[data-act="all"]').onclick=()=>{ activeCat='ALL'; CT.closeDrawer(); render(); };
    const btnNew = drawer.querySelector('[data-act="new"]');
    if(btnNew) btnNew.onclick=()=>{ CT.closeDrawer(); createCategoryInline(); };

    drawer.querySelectorAll('.list li').forEach(li=>{
      const id=li.dataset.id;
      li.querySelector('[data-act="filter"]').onclick=()=>{ activeCat=id; CT.closeDrawer(); render(); };
      const delBtn = li.querySelector('[data-act="del"]');
      if(delBtn) delBtn.onclick=()=>{
        // удаляем только пустые
        if(counts(id)>0){ CT.toast('Kategorie nicht leer','err'); return; }
        const cur=CT.storage.read(CT_KEYS.CATS,[]).filter(x=>x.id!==id);
        CT.storage.write(CT_KEYS.CATS, cur); cats=cur;
        CT.toast('Kategorie gelöscht','ok');
        li.remove();
      };
    });
  };

  document.getElementById('btnNew').onclick=()=>editTool(null);
  document.getElementById('toolSearch').addEventListener('input', render);
  CT.bindGlobalSearch(()=>render());
  render();
});
</script>
</body>
</html>
