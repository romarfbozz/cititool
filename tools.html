
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Werkzeugs­chrank</title>
  <link rel="stylesheet" href="./ui/core.css">
</head>
<body data-active="tools">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html"><img src="./ui/brand.png" class="badge" alt=""><div class="tit"><div class="title">CitiTool</div><div class="subtitle">Werkzeuge</div></div></a>
    <div class="actions">
      <button class="icon-btn" id="btnCat" title="Kategorien"><svg><use href="./ui/icons.svg#list"/></svg></button>
      <button class="icon-btn" id="btnAdd" title="Neu"><svg><use href="./ui/icons.svg#plus"/></svg></button>
      <button class="icon-btn" data-ct="search-toggle"><svg><use href="./ui/icons.svg#search"/></svg></button>
    </div>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" id="toolSearch" placeholder="Werkzeug suchen…"></div>

<main class="container" id="toolList"></main>
<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();
  let tools = CT.storage.read(CT_KEYS.TOOLS, []);
  let cats  = CT.storage.read(CT_KEYS.CATS, []);
  const list = document.getElementById('toolList');

  /* ---------- Rendering ---------- */
  function render(filter=''){
    list.innerHTML='';
    const q = filter.toLowerCase();
    tools.filter(t=>!q || t.name.toLowerCase().includes(q) || t.code.toLowerCase().includes(q) || t.iso?.toLowerCase().includes(q))
         .forEach(t=>{
      const el=document.createElement('div'); el.className='card';
      el.innerHTML=`
        <div class="row between">
          <div class="row gap">
            ${t.imgData?`<img src="${t.imgData}" class="thumb" alt="">`:''}
            <div>
              <div class="name">${CT.escape(t.name)}</div>
              <div class="muted">${CT.escape(t.code||'')}</div>
            </div>
          </div>
          <button class="icon-btn" aria-label="Info"><svg><use href="./ui/icons.svg#info"/></svg></button>
        </div>`;
      el.querySelector('.icon-btn').onclick=()=>showInfo(t);
      list.appendChild(el);
    });
  }
  render();

  /* ---------- Suche ---------- */
  document.getElementById('toolSearch').addEventListener('input', e=>render(e.target.value));

  /* ---------- Drawer Kategorien ---------- */
  function openCats(){
    const body = cats.map(c=>{
      const count = tools.filter(t=>t.cat===c).length;
      return `<li><span>${c}</span><span class="muted">${count}</span></li>`;
    }).join('') + '<li><button class="btn ghost full" id="addCat">+ Neue Kategorie</button></li>';
    CT.openDrawer({title:'Kategorien', html:`<ul class="list">${body}</ul>`});
    document.getElementById('addCat').onclick=()=>{
      const html = `<label class="fld">Name<input id="newCat"></label>`;
      CT.openModal({title:'Neue Kategorie', html, okText:'Speichern', onOk:()=>{
        const v=document.getElementById('newCat').value.trim(); if(!v) return;
        cats.push(v); CT.storage.write(CT_KEYS.CATS,cats); CT.toast('Kategorie hinzugefügt','ok'); CT.closeModal(); CT.closeDrawer();
      }});
    };
  }
  document.getElementById('btnCat').onclick=openCats;

  /* ---------- Werkzeug-Editor ---------- */
  function openEditor(tool){
    const isNew=!tool;
    const t = tool || {id:CT.uid(), name:'', code:'', cat:'', iso:'', herst:'', note:'', imgData:''};
    const catOpts = cats.map(c=>`<option ${c===t.cat?'selected':''}>${c}</option>`).join('');
    const html = `
      <label class="fld">Name<input id="fName" value="${CT.escape(t.name)}"></label>
      <label class="fld">Code<input id="fCode" value="${CT.escape(t.code)}"></label>
      <label class="fld">Kategorie<select id="fCat">${catOpts}<option value="">+ Neue</option></select></label>
      <label class="fld">ISO<input id="fIso" value="${CT.escape(t.iso)}"></label>
      <label class="fld">Hersteller<input id="fHer" value="${CT.escape(t.herst)}"></label>
      <label class="fld">Notiz<textarea id="fNote">${CT.escape(t.note||'')}</textarea></label>
      <label class="fld">Foto<input type="file" id="fImg" accept="image/*"></label>
      ${t.imgData?`<img src="${t.imgData}" style="width:80px;border-radius:8px;margin-top:4px">`:''}
      ${!isNew?'<button class="btn warn" id="delTool">Löschen</button>':''}
    `;
    CT.openModal({title:isNew?'Neues Werkzeug':'Werkzeug', html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
      let newTool = {...t};
      newTool.name=document.getElementById('fName').value.trim();
      newTool.code=document.getElementById('fCode').value.trim();
      let catSel=document.getElementById('fCat').value;
      if(catSel==='+ Neue'){
        const v=prompt('Neue Kategorie:'); if(v){ cats.push(v); CT.storage.write(CT_KEYS.CATS,cats); catSel=v; }
      }
      newTool.cat=catSel;
      newTool.iso=document.getElementById('fIso').value.trim();
      newTool.herst=document.getElementById('fHer').value.trim();
      newTool.note=document.getElementById('fNote').value.trim();
      if(newTool.imgData==='') newTool.imgData=t.imgData;
      if(isNew) tools.push(newTool); else tools=tools.map(x=>x.id===newTool.id?newTool:x);
      CT.storage.write(CT_KEYS.TOOLS,tools);
      CT.toast('Gespeichert','ok'); render();
    }});
    const fImg=document.getElementById('fImg');
    fImg.onchange=e=>{
      const file=e.target.files[0]; if(!file) return;
      const r=new FileReader(); r.onload=ev=>{t.imgData=ev.target.result;}; r.readAsDataURL(file);
    };
    const del=document.getElementById('delTool');
    if(del) del.onclick=()=>{ tools=tools.filter(x=>x.id!==t.id); CT.storage.write(CT_KEYS.TOOLS,tools); CT.closeModal(); render(); CT.toast('Gelöscht','ok'); };
  }
  document.getElementById('btnAdd').onclick=()=>openEditor();

  /* ---------- Info ---------- */
  function showInfo(t){
    const html = `
      ${t.imgData?`<div class="imgwrap"><img src="${t.imgData}" alt=""></div>`:''}
      <b>${CT.escape(t.name)}</b>
      <div>${CT.escape(t.code)} • ${CT.escape(t.iso||'')} • ${CT.escape(t.herst||'')}</div>
      <div class="muted">${CT.escape(t.cat||'')}</div>
      <p>${CT.escape(t.note||'')}</p>
      <div class="row">
        <button class="btn ok" id="addSetup">+ Zu Setup</button>
        <button class="btn brand" id="edit">Bearbeiten</button>
      </div>`;
    CT.openModal({title:'Werkzeug', html, cancelText:'Schließen'});
    document.getElementById('edit').onclick=()=>{ CT.closeModal(); openEditor(t); };
    document.getElementById('addSetup').onclick=()=> addToSetup(t);
  }

  /* ---------- Zu Setup ---------- */
  function addToSetup(tool){
    const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
    const panels=['ro','ru'].map(side=>{
      const label=side==='ro'?'RO (G54)':'RU (G55)';
      const btns=live[side].map((v,i)=>{
        const busy=!!v;
        const txt=`${i+1}${busy?' • '+CT.getToolFromSlot(live,side,i)?.name||'' : ''}`;
        return `<button class="btn ${busy?'ghost':''}" data-side="${side}" data-slot="${i}" ${busy?'disabled':''}>${txt}</button>`;
      }).join('');
      return `<div class="drawer-block"><div class="hdr">${label}</div><div class="row">${btns}</div></div>`;
    }).join('');
    CT.openDrawer({title:'+ Zu Setup', html:panels});
    document.querySelectorAll('.drawer .btn').forEach(b=>{
      b.onclick=()=>{
        const s=b.dataset.side, slot=+b.dataset.slot;
        if(live[s][slot]){ CT.toast('Slot belegt','err'); return; }
        live[s][slot]={toolId:tool.id, note:''};
        CT.storage.write(CT_KEYS.SETUP,live);
        CT.closeDrawer(); CT.toast(`In ${s.toUpperCase()} #${slot+1} hinzugefügt`,'ok');
      };
    });
  }

  CT.bindGlobalSearch(()=>render());
});
</script>
</body>
</html>
