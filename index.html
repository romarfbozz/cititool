<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Dashboard</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    /* Локальный минимум — всё остальное из /ui */
    .tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem}
    .tile{display:grid;place-items:center;padding:14px;border:1px solid #e5ebf7;border-radius:14px;background:#fff}
    .tile:active{transform:translateY(1px)}
    .tile svg{width:28px;height:28px;margin-bottom:6px}
    .sub{font-size:12px;color:var(--muted)}

    .barwrap{position:relative;margin:8px 0}
    .barwrap .pct{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:12px;font-weight:700;color:var(--brand);pointer-events:none}

    .hscroll{display:flex;gap:.6rem;overflow:auto;padding-bottom:2px}
    .tool-chip{min-width:160px;display:grid;grid-template-columns:56px 1fr;gap:.6rem;align-items:center;border:1px solid #e5ebf7;border-radius:14px;background:#fff;padding:8px}
    .tool-chip .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f0f3fa}
    .thumb.ph{display:grid;place-items:center;color:#9cb1d9;font-weight:800}

    .quick-note{display:grid;gap:.5rem}
  </style>
</head>
<body data-active="dash">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit">
        <div class="title">CitiTool</div>
        <div class="subtitle">Dashboard</div>
      </div>
    </a>
    <div class="actions" style="display:flex;gap:.4rem;align-items:center">
      <button class="btn sm" id="btnBackup">Backup</button>
      <button class="btn ghost sm" id="btnRestore">Restore</button>
      <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
        <svg><use href="./ui/icons.svg#search"/></svg>
      </button>
    </div>
  </div>
</header>

<div class="searchbar collapsed">
  <input class="field" type="search" placeholder="Suchen…" id="globalSearch">
</div>

<main class="container" id="dashRoot">
  <!-- Schnellaktionen (плитки) -->
  <section class="section">
    <h2>Schnellaktionen</h2>
    <div class="tiles">
      <button class="tile" id="actNewSetup">
        <svg><use href="./ui/icons.svg#setup"/></svg>
        <div>Neues Setup</div>
      </button>
      <button class="tile" id="actNewTool">
        <svg><use href="./ui/icons.svg#tools"/></svg>
        <div>Neues Werkzeug</div>
      </button>
      <button class="tile" id="actFasen">
        <svg><use href="./ui/icons.svg#program"/></svg>
        <div>Fasen-Assist</div>
      </button>
      <button class="tile" id="actMaterial">
        <svg><use href="./ui/icons.svg#docs"/></svg>
        <div>Material-Assist</div>
      </button>
    </div>
  </section>

  <!-- Последние инструменты (из Live RO/RU) -->
  <section class="section">
    <h2>Letzte Tools (Live)</h2>
    <div id="recentTools" class="hscroll"></div>
    <div class="sub">Aus RO/G54 und RU/G55 • Klick → Setup</div>
  </section>

  <!-- Produktion -->
  <section class="section">
    <h2>Produktion</h2>
    <div id="prodList" class="stack"></div>
    <div class="row mt">
      <button class="btn brand" id="addJob">Neuer Auftrag</button>
    </div>
  </section>

  <!-- Быстрые заметки -->
  <section class="section">
    <h2>Schnell-Notiz</h2>
    <div class="quick-note">
      <input id="qnTitle" class="field" placeholder="Titel (optional)">
      <textarea id="qnBody" class="field" rows="4" placeholder="Kurze Notiz…"></textarea>
      <div class="row">
        <button class="btn brand" id="qnSave">Speichern</button>
        <button class="btn" id="qnClear">Leeren</button>
      </div>
    </div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
  CT.ready(() => {
    CT.ensureSeeds();

    // -------- Backup / Restore (весь localStorage) --------
    function dumpAllLS(){
      const data={};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        try{ data[k]=JSON.parse(localStorage.getItem(k)); }catch(e){ data[k]=localStorage.getItem(k); }
      }
      return data;
    }
    document.getElementById('btnBackup').onclick=()=>{
      const all=dumpAllLS();
      CT.exportJSON('citi_backup.json', all);
      CT.toast('Backup erstellt','ok');
    };
    document.getElementById('btnRestore').onclick=()=>{
      CT.importJSON().then(obj=>{
        if(!obj || typeof obj!=='object') return CT.toast('Falsches Format','err');
        CT.openModal({
          title:'Restore bestätigen',
          html:'Vorhandene Daten überschreiben?',
          okText:'Überschreiben', cancelText:'Abbrechen',
          onOk:()=>{
            Object.keys(obj).forEach(k=> localStorage.setItem(k, JSON.stringify(obj[k])));
            CT.toast('Wiederhergestellt','ok'); location.reload();
          }
        });
      });
    };

    // -------- Schnellaktionen плитками --------
    document.getElementById('actNewSetup').onclick = ()=> location.href='./setup.html';
    document.getElementById('actNewTool').onclick = ()=> {
      CT.openModal({
        title:'Neues Werkzeug',
        html:'Werkzeugs­chrank öffnen?',
        okText:'Öffnen', cancelText:'Abbrechen',
        onOk:()=>location.href='./tools.html'
      });
    };
    document.getElementById('actFasen').onclick = ()=> location.href='./assist.html';
    document.getElementById('actMaterial').onclick = ()=> location.href='./assist.html';

    // -------- Последние инструменты из Live --------
    function renderRecentTools(){
      const wrap = document.getElementById('recentTools');
      wrap.innerHTML='';
      const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
      const tools = CT.storage.read(CT_KEYS.TOOLS, []);
      const ids = new Set();
      ['ro','ru'].forEach(side=>{
        live[side].forEach(cell=>{
          if(cell && cell.toolId) ids.add(cell.toolId);
        });
      });
      const arr = [...ids].map(id=> tools.find(t=>t.id===id)).filter(Boolean);
      if(!arr.length){ wrap.innerHTML='<div class="muted">Keine Tools in Live</div>'; return; }
      arr.forEach(t=>{
        const chip=document.createElement('button');
        chip.className='tool-chip';
        const hasImg = !!t.imgData;
        chip.innerHTML = `
          ${hasImg ? `<img class="thumb" src="${t.imgData}" alt="">`
                    : `<div class="thumb ph">No</div>`}
          <div>
            <div class="name" style="font-weight:800">${CT.escape(t.name)}</div>
            <div class="sub">${CT.escape(t.code||'')}</div>
          </div>`;
        chip.onclick=()=> location.href='./setup.html';
        wrap.appendChild(chip);
      });
    }
    renderRecentTools();

    // -------- Produktion --------
    const prodList = document.getElementById('prodList');
    function renderProd(){
      prodList.innerHTML = '';
      const data = CT.storage.read(CT_KEYS.DASH, { produktion:[], checklist:[] });
      const arr = data.produktion||[];
      if(!arr.length){
        prodList.innerHTML = '<div class="muted">Keine Aufträge</div>';
        return;
      }
      arr.forEach(item=>{
        const pct = Math.min(100, Math.round((item.madeQty / Math.max(1,item.targetQty))*100));
        const el = document.createElement('div');
        el.className='card job';
        el.innerHTML = `
          <div class="job-hdr" style="display:flex;justify-content:space-between;align-items:center">
            <b>${CT.escape(item.title)}</b>
            <button class="icon-btn" aria-label="Info"><svg><use href="./ui/icons.svg#info"/></svg></button>
          </div>
          <div class="barwrap">
            <div class="bar"><div style="width:${pct}%"></div></div>
            <div class="pct">${pct}%</div>
          </div>
          <div class="job-meta">${item.madeQty} / ${item.targetQty} • ${new Date(item.date).toLocaleDateString()}</div>
        `;
        el.querySelector('button').onclick = () => editJob(item);
        prodList.appendChild(el);
      });
    }
    function editJob(item){
      const html = `
        <label class="fld">Titel<input id="j_t" value="${CT.escape(item.title)}"></label>
        <label class="fld">Zielmenge<input id="j_q" type="number" inputmode="numeric" value="${item.targetQty}"></label>
        <label class="fld">Bereits gefertigt<input id="j_m" type="number" inputmode="numeric" value="${item.madeQty}"></label>
        <div class="row"><button class="btn warn" id="del">Löschen</button></div>`;
      CT.openModal({title:'Auftrag', html, okText:'Speichern', cancelText:'Schließen', onOk:()=>{
        const data = CT.storage.read(CT_KEYS.DASH, { produktion:[], checklist:[] });
        const idx = data.produktion.findIndex(p=>p.id===item.id);
        if(idx>-1){
          data.produktion[idx].title = document.getElementById('j_t').value.trim()||'Ohne Titel';
          data.produktion[idx].targetQty = parseInt(document.getElementById('j_q').value||0,10);
          data.produktion[idx].madeQty = parseInt(document.getElementById('j_m').value||0,10);
          CT.storage.write(CT_KEYS.DASH, data); CT.toast('Gespeichert','ok'); renderProd();
        }
      }});
      document.getElementById('del').onclick = ()=>{
        const data = CT.storage.read(CT_KEYS.DASH, { produktion:[], checklist:[] });
        data.produktion = data.produktion.filter(p=>p.id!==item.id);
        CT.storage.write(CT_KEYS.DASH, data); CT.closeModal(); CT.toast('Gelöscht','ok'); renderProd();
      };
    }
    document.getElementById('addJob').onclick=()=>{
      const html = `
        <label class="fld">Titel<input id="n_t" placeholder="Auftrag"></label>
        <label class="fld">Zielmenge<input id="n_q" type="number" inputmode="numeric" placeholder="100"></label>`;
      CT.openModal({title:'Neuer Auftrag', html, okText:'Anlegen', onOk:()=>{
        const data = CT.storage.read(CT_KEYS.DASH, { produktion:[], checklist:[] });
        data.produktion.push({id:CT.uid(), title:document.getElementById('n_t').value||'Auftrag',
          targetQty:parseInt(document.getElementById('n_q').value||0,10), madeQty:0, date:Date.now()});
        CT.storage.write(CT_KEYS.DASH, data); CT.toast('Angelegt','ok'); renderProd();
      }});
    };
    renderProd();

    // -------- Schnell-Notиз --------
    document.getElementById('qnSave').onclick=()=>{
      const title=(document.getElementById('qnTitle').value||'Quick Note').trim();
      const body=(document.getElementById('qnBody').value||'').trim();
      if(!body){ return CT.toast('Leerer Text','err'); }
      const docs=CT.storage.read(CT_KEYS.DOCS, []);
      docs.push({id:CT.uid(), title, category:'Quick Notes', tags:['quick'], body, favorite:false});
      CT.storage.write(CT_KEYS.DOCS, docs);
      document.getElementById('qnBody').value=''; CT.toast('Gespeichert','ok');
    };
    document.getElementById('qnClear').onclick=()=>{
      document.getElementById('qnTitle').value='';
      document.getElementById('qnBody').value='';
    };

    // -------- Поиск по секциям --------
    CT.bindGlobalSearch((q)=>{
      document.querySelectorAll('.section').forEach(sec=>{
        if(!q){ sec.style.display=''; return; }
        sec.style.display = sec.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  });
</script>
</body>
</html>