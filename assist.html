<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Assistenten</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    /* только минимум локальных стилей, остальное — из /ui */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    @media (max-width:480px){ .grid2{grid-template-columns:1fr} }
    .mutetip{font-size:13px;color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; white-space:pre-wrap}
    .subpanel.hidden{display:none}
    .chip{border:1px solid #dbe5ff;background:#fff;border-radius:12px;padding:6px 10px}
    /* чуть выразительнее табы и кнопки (в рамках /ui) */
    .tabs{gap:.35rem}
    .tab{padding:10px 14px;border-radius:12px}
    .tab.active{background:#eef3ff;color:var(--brand);border-color:#cfe0ff}
    .btn.ghost.sm{height:36px;padding:0 10px}
  </style>
</head>
<body data-active="setup">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Assistenten</div></div>
    </a>
    <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
      <svg><use href="./ui/icons.svg#search"/></svg>
    </button>
  </div>
</header>
<div class="searchbar collapsed">
  <input class="field" type="search" placeholder="Suchen…" id="asSearch">
</div>

<main class="container">
  <section class="section">
    <h2>Assistenten</h2>

    <!-- Табы -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="mat">Material-Assistent (Drehen)</button>
      <button class="tab" data-tab="pass">Passmassen (Schnellsuche)</button>
      <button class="tab" data-tab="fasen">Fasen (3 aus 4 + Winkel)</button>
    </div>

    <!-- PANEL: MATERIAL -->
    <div class="subpanel" id="panel-mat">
      <div class="row">
        <select id="mat">
          <option>1.4112</option><option>1.4104</option><option>1.4122</option>
          <option>F75</option><option>Ms58</option>
        </select>
        <select id="mode">
          <option>Schruppen</option><option>Schlichten</option>
        </select>
      </div>

      <div class="grid2">
        <label class="fld">Ø (mm)<input id="mmD" type="number" inputmode="decimal" placeholder="z.B. 20"></label>
        <label class="fld">L (mm)<input id="mmL" type="number" inputmode="decimal" placeholder="optional"></label>
        <label class="fld">Vc (m/min)<input id="vc" type="number" inputmode="decimal" value="180"></label>
        <label class="fld">fn (mm/U)<input id="fn" type="number" inputmode="decimal" value="0.2"></label>
      </div>

      <div id="calcOut" class="calc">n = —, Vf = —</div>
      <div id="calcHint" class="mutetip">Gib Ø, Vc, fn ein — wir berechnen n und Vf.</div>

      <div class="row mt">
        <button class="btn brand" id="saveNote">In Notiz speichern</button>
      </div>
    </div>

    <!-- PANEL: PASSMASSEN -->
    <div class="subpanel hidden" id="panel-pass">
      <div class="grid2">
        <label class="fld">Nennmaß (mm)<input id="passNom" type="number" inputmode="decimal" placeholder="z.B. 10"></label>
        <label class="fld">Schnellsuche<input id="passQ" placeholder="z.B. d10 h7 oder H7/g6"></label>
      </div>

      <div class="muted" style="margin:.4rem 0">Vorauswahl für Nennmaß:</div>
      <div class="row" id="passChips"></div>

      <div id="passOut" class="mono muted" style="margin-top:.6rem">Gib Nennmaß oder Passmaß ein…</div>
      <div class="row mt">
        <button class="btn ghost sm" id="passClear">Leeren</button>
      </div>
    </div>

    <!-- PANEL: FASEN (3 из 4 координат + угол) -->
    <div class="subpanel hidden" id="panel-fasen">
      <div class="grid2">
        <label class="fld">Winkel α (°)<input id="faAngle" type="number" inputmode="decimal" value="45"></label>
        <label class="fld">X Start<input id="faXs" type="number" inputmode="decimal" placeholder="z.B. 10.0"></label>
        <label class="fld">Z Start<input id="faZs" type="number" inputmode="decimal" placeholder="z.B. 0.0"></label>
        <label class="fld">X Ende<input id="faXe" type="number" inputmode="decimal" placeholder="z.B. 11.0"></label>
        <label class="fld">Z Ende<input id="faZe" type="number" inputmode="decimal" placeholder="z.B. 1.0"></label>
      </div>

      <div class="mutetip" id="faHint" style="margin-top:.4rem">
        Fülle beliebige <b>3 von 4</b> Koordinaten (Xs, Zs, Xe, Ze) + Winkel — wir lösen die fehlende.
      </div>

      <div class="mono" id="faOut" style="margin-top:.6rem">G-Code Vorschau erscheint hier…</div>
      <div class="row mt">
        <button class="btn" id="faCopy">In Zwischenablage</button>
      </div>
    </div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();

  /* ===== ТАБЫ ===== */
  const tabs = document.getElementById('tabs');
  function showTab(key){
    tabs.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
    document.querySelectorAll('.subpanel').forEach(p=>p.classList.add('hidden'));
    document.getElementById('panel-'+key).classList.remove('hidden');
  }
  tabs.addEventListener('click', (e)=>{
    const b=e.target.closest('.tab'); if(!b) return;
    showTab(b.dataset.tab);
  });

  /* ===== MATERIAL ===== */
  const $D=mmD, $Vc=vc, $Fn=fn, $Calc=calcOut, $Hint=calcHint;
  function calc(){
    const D=parseFloat($D.value||0), Vc=parseFloat($Vc.value||0), fnv=parseFloat($Fn.value||0);
    if(!D||!Vc||!fnv){ $Calc.textContent='n = —, Vf = —'; $Hint.textContent='Gib Ø, Vc, fn ein — wir berechnen n und Vf.'; return; }
    const n = Math.round((1000*Vc)/(Math.PI*D));
    const Vf = Math.round(fnv * n);
    $Calc.textContent = `n = ${n} 1/min,  Vf = ${Vf} mm/min`;
    if(n>6000) { $Hint.textContent='Hinweis: n sehr hoch — prüfen (Klemmung, Vc senken).'; }
    else if(n<200) { $Hint.textContent='Hinweis: n sehr niedrig — Schnitt evtl. unterbrochen.'; }
    else { $Hint.textContent='OK'; }
  }
  [$D,$Vc,$Fn].forEach(el=>el.addEventListener('input', calc));
  calc();

  saveNote.onclick=()=>{
    const txt =
`Material: ${mat.value}, Modus: ${mode.value}
Ø=${$D.value||'—'}mm${mmL.value?`, L=${mmL.value}mm`:''}
Vc=${$Vc.value||'—'} m/min, fn=${$Fn.value||'—'} mm/U
${$Calc.textContent}`;
    const docs = CT.storage.read(CT_KEYS.DOCS, []);
    docs.push({id:CT.uid(), title:`Schnittdaten ${mat.value}`, category:'Material', tags:['calc','drehen'], body:txt, favorite:false});
    CT.storage.write(CT_KEYS.DOCS, docs);
    CT.toast('Als Notiz gespeichert','ok');
  };

  /* ===== PASSMASSEN (пресеты по номиналу) ===== */
  const PASS_PRESETS = {
    '8':  ['d8 h7','H7/g6'],
    '10': ['d10 h7','H7/g6','h7/f7'],
    '12': ['d12 h6','H7/g6','h8/f7'],
    '16': ['d16 h7','H7/g6'],
    '20': ['d20 h7','H7/g6','h7/f7']
  };
  const PASS_INFO = {
    'd8 h7':'Welle d8 h7: 8.000 / −0.014 (Demo)',
    'd10 h7':'Welle d10 h7: 10.000 / −0.015 (Demo)',
    'd12 h6':'Welle d12 h6: 12.000 / −0.006 (Demo)',
    'd16 h7':'Welle d16 h7: 16.000 / −0.018 (Demo)',
    'd20 h7':'Welle d20 h7: 20.000 / −0.021 (Demo)',
    'H7/g6':'Loch H7 / Welle g6: Übergang/Spiel (Demo)',
    'h7/f7':'Welle h7 / Loch F7: enger Übergang (Demo)',
    'h8/f7':'Loch H8 / Welle F7: enger Übergang (Demo)',
  };
  const passChips = document.getElementById('passChips');
  const passOut   = document.getElementById('passOut');

  function renderPresetsFor(nom){
    passChips.innerHTML='';
    const list = PASS_PRESETS[(nom||'').trim()] || [];
    if(!list.length){ passChips.innerHTML='<span class="muted">Keine Presets</span>'; return; }
    list.forEach(k=>{
      const b=document.createElement('button');
      b.className='chip';
      b.textContent=k;
      b.onclick=()=> showPass(k);
      passChips.appendChild(b);
    });
  }
  function showPass(key){
    passOut.textContent = PASS_INFO[key] || '—';
    CT.toast(key,'ok',1000);
  }
  passNom.addEventListener('input', ()=>{ renderPresetsFor(passNom.value); });
  passQ.addEventListener('input', ()=>{
    const q=(passQ.value||'').trim();
    if(!q){ passOut.textContent='Gib Nennmaß oder Passmaß ein…'; return; }
    const v1=q, v2=q.replace(' ','/'), v3=q.replace('/',' ');
    if(PASS_INFO[v1]) return showPass(v1);
    if(PASS_INFO[v2]) return showPass(v2);
    if(PASS_INFO[v3]) return showPass(v3);
    passOut.textContent='—';
  });
  passClear.onclick=()=>{ passNom.value=''; passQ.value=''; passChips.innerHTML=''; passOut.textContent='Gib Nennmaß oder Passmaß ein…'; };

  /* ===== FASEN: 3 из 4 координат + угол =====
     Дано: α, и любые 3 из (Xs, Xe, Zs, Ze). Ищем 4-ю.
     Связь: tan α = ΔZ / ΔX, где ΔX = Xe − Xs, ΔZ = Ze − Zs.
     Если известны обе X (или обе Z) — вычисляем недостающую Z (или X).
     Если известны Xs, Ze, Zs — находим Xe, и т.д.
     Плюс считаем длину L = sqrt(ΔX^2+ΔZ^2) и черновой G-Code.
  */
  const $fa = { a:faAngle, Xs:faXs, Zs:faZs, Xe:faXe, Ze:faZe, out:faOut, hint:faHint };
  function parse(v){ const n=parseFloat(v); return Number.isFinite(n)?n:null; }

  function solveChamfer(){
    const a = parse($fa.a.value);
    const Xs = parse($fa.Xs.value), Xe = parse($fa.Xe.value);
    const Zs = parse($fa.Zs.value), Ze = parse($fa.Ze.value);

    if(!a){ $fa.out.textContent='Bitte Winkel angeben.'; return; }
    const rad = a*Math.PI/180;
    const tanA = Math.tan(rad);

    let known = {Xs: Xs!=null, Xe: Xe!=null, Zs: Zs!=null, Ze: Ze!=null};
    const count = Object.values(known).filter(Boolean).length;
    if(count < 3){ $fa.out.textContent='Gib mindestens 3 Koordinaten ein (Xs, Xe, Zs, Ze).'; return; }

    let _Xs = Xs, _Xe = Xe, _Zs = Zs, _Ze = Ze;

    // 1) Если известны обе X → считаем одну из Z
    if(known.Xs && known.Xe && (!known.Zs || !known.Ze)){
      const dX = _Xe - _Xs;
      const dZ = Math.abs(dX)*tanA;
      if(known.Zs && !known.Ze){ _Ze = _Zs + Math.sign(dX||1)*Math.sign(tanA||1)*dZ; known.Ze=true; }
      else if(known.Ze && !known.Zs){ _Zs = _Ze - Math.sign(dX||1)*Math.sign(tanA||1)*dZ; known.Zs=true; }
    }
    // 2) Если известны обе Z → считаем одну из X
    if(known.Zs && known.Ze && (!known.Xs || !known.Xe)){
      const dZ = _Ze - _Zs;
      const dX = Math.abs(dZ)/ (tanA||1e-9);
      if(known.Xs && !known.Xe){ _Xe = _Xs + Math.sign(dZ||1)*dX; known.Xe=true; }
      else if(known.Xe && !known.Xs){ _Xs = _Xe - Math.sign(dZ||1)*dX; known.Xs=true; }
    }
    // 3) Смешанные случаи: известны Xs, Zs, и один из (Xe|Ze)
    if(known.Xs && known.Zs && !known.Xe && known.Ze){
      const dZ = _Ze - _Zs;
      const dX = Math.abs(dZ)/ (tanA||1e-9);
      _Xe = _Xs + Math.sign(dZ||1)*dX; known.Xe=true;
    }
    if(known.Xs && known.Zs && known.Xe && !known.Ze){
      const dX = _Xe - _Xs;
      const dZ = Math.abs(dX)*tanA;
      _Ze = _Zs + Math.sign(dX||1)*dZ; known.Ze=true;
    }
    // 4) Xe, Ze и один из (Xs|Zs)
    if(!known.Xs && known.Zs && known.Xe && known.Ze){
      const dZ = _Ze - _Zs;
      const dX = Math.abs(dZ)/ (tanA||1e-9);
      _Xs = _Xe - Math.sign(dZ||1)*dX; known.Xs=true;
    }
    if(known.Xs && !known.Zs && known.Xe && known.Ze){
      const dX = _Xe - _Xs;
      const dZ = Math.abs(dX)*tanA;
      _Zs = _Ze - Math.sign(dX||1)*dZ; known.Zs=true;
    }

    // Проверка: всё ли нашли
    if(!(known.Xs && known.Xe && known.Zs && known.Ze)){
      $fa.out.textContent='Nicht eindeutig. Bitte andere 3 Werte angeben (oder Richtung prüfen).';
      return;
    }

    const dX = _Xe - _Xs;
    const dZ = _Ze - _Zs;
    const L  = Math.sqrt(dX*dX + dZ*dZ);

    // Вывод + G-Code (очень базовый)
    let g = [];
    g.push(`(Fase: α=${a}°, L≈${L.toFixed(3)} mm)`);
    g.push(`(Start: X${_Xs.toFixed(3)} Z${_Zs.toFixed(3)})`);
    g.push(`(Ende : X${_Xe.toFixed(3)} Z${_Ze.toFixed(3)})`);
    g.push(`G01 X${_Xe.toFixed(3)} Z${_Ze.toFixed(3)} F...`);

    $fa.out.textContent = g.join('\n');

    // Подсказка что посчитали
    const missing = [];
    if(Xs==null) missing.push('Xs');
    if(Zs==null) missing.push('Zs');
    if(Xe==null) missing.push('Xe');
    if(Ze==null) missing.push('Ze');
    $fa.hint.innerHTML = missing.length
      ? `Berechnet: <b>${missing.join(', ')}</b>.`
      : `Alle 4 Koordinaten bekannt.`;
  }

  [$fa.a, $fa.Xs, $fa.Zs, $fa.Xe, $fa.Ze].forEach(el=>el.addEventListener('input', solveChamfer));
  solveChamfer();

  faCopy.onclick=()=>{
    navigator.clipboard?.writeText(faOut.textContent||'')
      .then(()=>CT.toast('Kopiert','ok'))
      .catch(()=>CT.toast('Clipboard nicht verfügbar','err'));
  };

  /* ===== Глобальный поиск: прячем панели без совпадений ===== */
  CT.bindGlobalSearch((q)=>{
    document.querySelectorAll('.subpanel').forEach(sec=>{
      if(!q){ sec.style.display=''; return; }
      const hit = sec.textContent.toLowerCase().includes(q);
      sec.style.display = hit ? '' : 'none';
    });
  });

  // стартовая вкладка
  showTab('mat');
});
</script>
</body>
</html>