
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Assistenten</title>
  <link rel="stylesheet" href="./ui/core.css">
</head>
<body data-active="setup">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html"><img src="./ui/brand.png" class="badge" alt=""><div class="tit"><div class="title">CitiTool</div><div class="subtitle">Assistenten</div></div></a>
    <button class="icon-btn" data-ct="search-toggle"><svg><use href="./ui/icons.svg#search"/></svg></button>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Suchen…" id="asSearch"></div>

<main class="container">
  <!-- MATERIAL-ASSIST -->
  <section class="section">
    <h2>Material-Assistent (Drehen)</h2>
    <div class="row">
      <select id="mat">
        <option>1.4112</option><option>1.4104</option><option>1.4122</option><option>F75</option><option>Ms58</option>
      </select>
      <select id="mode"><option>Schruppen</option><option>Schlichten</option></select>
    </div>
    <div class="grid2">
      <label class="fld">Ø (mm)<input id="mmD" type="number" inputmode="decimal" placeholder="z.B. 20"></label>
      <label class="fld">L (mm)<input id="mmL" type="number" inputmode="decimal" placeholder="optional"></label>
      <label class="fld">Vc (m/min)<input id="vc" type="number" inputmode="decimal" value="180"></label>
      <label class="fld">fn (mm/U)<input id="fn" type="number" inputmode="decimal" value="0.2"></label>
    </div>
    <div class="calc" id="calcOut">n = —, Vf = —</div>
    <div class="row"><button class="btn brand" id="saveNote">In Notiz speichern</button></div>
  </section>

  <!-- FASEN-ASSIST -->
  <section class="section">
    <h2>Fasen-Assistent (Drehen)</h2>
    <div class="grid2">
      <label class="fld">Winkel A (°)<input id="faA" type="number" inputmode="decimal" value="45"></label>
      <label class="fld">Xstart (Ø mm)<input id="faXs" type="number" inputmode="decimal" placeholder="z.B. 20"></label>

      <label class="fld">Zstart (mm)<input id="faZs" type="number" inputmode="decimal" value="0"></label>
      <label class="fld">Zend (mm)<input id="faZe" type="number" inputmode="decimal" placeholder="leer = berechnen"></label>

      <label class="fld">L axial (mm)<input id="faL" type="number" inputmode="decimal" placeholder="leer = berechnen"></label>
      <label class="fld">Xend (Ø mm)<input id="faXe" type="number" inputmode="decimal" placeholder="leer = berechnen"></label>
    </div>
    <div class="row">
      <button class="btn" id="faCalc">Berechnen</button>
      <button class="btn ok" id="faCopy">G-Code kopieren</button>
      <button class="btn brand" id="faSave">Als Notiz speichern</button>
    </div>
    <div class="calc" id="faOut">G-Code: —</div>
    <div class="muted" style="margin-top:.25rem">
      Hinweis: Beziehung <code>ΔX = 2 · L · tan(A)</code>, wobei <code>ΔX = Xstart − Xend</code>, <code>L = |Zend − Zstart|</code>.
    </div>
  </section>

  <!-- PASSMAß QUICK -->
  <section class="section">
    <h2>Passmassen (Schnellsuche)</h2>
    <input class="field" id="passQ" placeholder="z.B. d12 h6 oder H7/g6">
    <div id="passOut" class="muted">Gib einen Passmaß an…</div>
  </section>

  <!-- PASSMAß ERWEITERT -->
  <section class="section">
    <h2>Passmassen (Erweitert 10–18 mm)</h2>
    <div class="row">
      <label class="fld" style="flex:1;min-width:120px">Ø Nenn (mm)
        <input id="fitD" type="number" inputmode="decimal" value="12">
      </label>
      <label class="fld" style="flex:1;min-width:160px">Loch
        <select id="fitHole">
          <option value="H7">H7</option>
        </select>
      </label>
      <label class="fld" style="flex:1;min-width:160px">Welle
        <select id="fitShaft">
          <option value="h6">h6</option>
          <option value="g6">g6</option>
          <option value="p6">p6</option>
        </select>
      </label>
      <button class="btn" id="fitCalc">Berechnen</button>
    </div>

    <div class="row">
      <input class="field" id="fitFast" placeholder="Typ schnell setzen (z.B. H7/g6, H7/h6, H7/p6)">
      <button class="btn ghost" id="fitPreset">Setzen</button>
    </div>

    <div class="card" id="fitOut" style="margin-top:.5rem">
      <div class="muted">Wähle Ø und Toleranzen, dann «Berechnen».</div>
    </div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();

  /* ---------- Material-Assist ---------- */
  function calcMat(){
    const D=parseFloat(mmD.value||0), Vc=parseFloat(vc.value||0), fnv=parseFloat(fn.value||0);
    if(!D||!Vc||!fnv){ calcOut.textContent='n = —, Vf = —'; return; }
    const n = Math.round((1000*Vc)/(Math.PI*D));
    const Vf = Math.round(fnv * n);
    calcOut.textContent = \`n = \${n} 1/min,  Vf = \${Vf} mm/min\`;
    if(n>6000) CT.toast('n sehr hoch — prüfen!', 'warn', 1500);
  }
  [mmD,vc,fn].forEach(el=>el.addEventListener('input', calcMat)); calcMat();

  saveNote.onclick=()=>{
    const txt = \`Material: \${mat.value}, Modus: \${mode.value}\\nØ=\${mmD.value}mm, Vc=\${vc.value}m/min, fn=\${fn.value}mm/U\\n\${calcOut.textContent}\`;
    const docs = CT.storage.read(CT_KEYS.DOCS, []);
    docs.push({id:CT.uid(), title:\`Schnittdaten \${mat.value}\`, category:'Material', tags:['calc','drehen'], body:txt, favorite:false});
    CT.storage.write(CT_KEYS.DOCS, docs); CT.toast('Als Notiz gespeichert','ok');
  };

  /* ---------- Fasen-Assist ---------- */
  function deg2rad(a){ return a*Math.PI/180; }
  function round3(v){ return Math.round((v + Number.EPSILON)*1000)/1000; }

  function computeChamfer(){
    const A = parseFloat(faA.value||0);
    const Xs = parseFloat(faXs.value||0);
    const Zs = parseFloat(faZs.value||0);
    let Ze = faZe.value===''? null : parseFloat(faZe.value);
    let L  = faL.value==='' ? null : parseFloat(faL.value);
    let Xe = faXe.value===''? null : parseFloat(faXe.value);

    if(!A || !Xs){ CT.toast('A und Xstart sind Pflicht', 'err'); return null; }

    if(Ze!==null && L===null) L = Math.abs(Ze - Zs);
    if(L!==null && Ze===null) Ze = Zs + L;

    const tanA = Math.tan(deg2rad(A));
    if(Xe===null && L!==null) Xe = Xs - 2*L*tanA;
    if(L===null && Xe!==null){
      const dX = Xs - Xe;
      L = dX / (2*tanA);
      Ze = Zs + L;
    }

    if([Xe,Ze,L].some(v=>v===null || !isFinite(v))){
      CT.toast('Gib 3 von 4 an: (Xe | Ze | L) + Winkel', 'err');
      return null;
    }

    Xe = round3(Xe); Ze = round3(Ze); L = round3(L);
    return {A, Xs, Xe, Zs, Ze, L};
  }

  function buildGcode(sol){
    const feed = 0.15; // Demo
    const lines = [
      '(Fase)',
      \`G1 X\${round3(sol.Xs)} Z\${round3(sol.Zs)}\`,
      \`G1 X\${round3(sol.Xe)} Z\${round3(sol.Ze)} F\${feed}\`,
    ];
    return lines.join('\\n');
  }

  function renderChamfer(){
    const sol = computeChamfer(); if(!sol) { faOut.textContent='G-Code: —'; return; }
    const g = buildGcode(sol);
    faOut.textContent = 'G-Code:\\n' + g;
    return {sol, g};
  }

  [faA,faXs,faZs,faZe,faL,faXe].forEach(el=>el.addEventListener('input', renderChamfer));
  faCalc.onclick = renderChamfer;
  faCopy.onclick = ()=>{
    const r = renderChamfer(); if(!r) return;
    navigator.clipboard?.writeText(r.g).then(()=>CT.toast('G-Code kopiert','ok')).catch(()=>CT.toast('Kopieren fehlgeschlagen','err'));
  };
  faSave.onclick = ()=>{
    const r = renderChamfer(); if(!r) return;
    const {sol, g} = r;
    const body = [
      \`A=\${sol.A}°, Xstart=\${sol.Xs}mm, Xend=\${sol.Xe}mm\`,
      \`Zstart=\${sol.Zs}mm, Zend=\${sol.Ze}mm, L=\${sol.L}mm\`,
      '',
      g
    ].join('\\n');
    const docs = CT.storage.read(CT_KEYS.DOCS, []);
    docs.push({id:CT.uid(), title:\`Fase \${sol.A}°\`, category:'Fasen', tags:['drehen','gcode'], body, favorite:false});
    CT.storage.write(CT_KEYS.DOCS, docs); CT.toast('Notiz gespeichert','ok');
  };

  /* ---------- Passmaß Quick ---------- */
  const passDB = {
    'd12 h6': 'Welle d12, Bohrung h6: Spiel 0…+X (Demo)',
    'H7/g6': 'Loch H7 mit Welle g6: Übergang/Spiel (Demo)',
    'H7/h6': 'Typisch: leichtes Spiel (Demo)'
  };
  passQ.addEventListener('input', ()=>{
    const q=(passQ.value||'').trim(); passOut.textContent = passDB[q] || '—';
  });

  /* ---------- Passmaß Erweitert (Demo-Daten 10–18 mm) ---------- */
  // Значения отклонений в микрометрах (µm) для диапазона 10–18 мм.
  // Упрощённая таблица: H7, h6, g6, p6.
  // Источник не подключаем — ориентировочный демо-набор для офлайн-расчётов.
  const tol = {
    hole: {
      'H7': { lo: 0, up: 21 } // H7: 0…+21 µm
    },
    shaft: {
      'h6': { lo: -10, up: 0 },   // h6: −10…0 µm
      'g6': { lo: -14, up: -4 },  // g6: −14…−4 µm
      'p6': { lo: +6,  up: +16 }  // p6: +6…+16 µm
    }
  };

  function umToMm(u){ return u/1000; }
  function fmt(v){ return (Math.round(v*1000)/1000).toFixed(3); } // 0.001 mm

  function calcFit(){
    const D = parseFloat(fitD.value||0);
    const H = fitHole.value;
    const S = fitShaft.value;
    if(!(D>=10 && D<=18)){ CT.toast('Demo-Bereich: Ø 10–18 mm', 'warn'); }

    const h = tol.hole[H], s = tol.shaft[S];
    if(!h || !s){ CT.toast('Unbekannte Toleranz', 'err'); return; }

    // Предельные размеры (мм)
    const holeMin = D + umToMm(h.lo);
    const holeMax = D + umToMm(h.up);
    const shaftMin = D + umToMm(s.lo);
    const shaftMax = D + umToMm(s.up);

    // Зазор/натяг (мм)
    const clearanceMin = holeMin - shaftMax; // min clearance (может быть отриц. = натяг)
    const clearanceMax = holeMax - shaftMin; // max clearance

    const type =
      clearanceMax < 0 ? 'Übermaß (Presssitz)' :
      clearanceMin > 0 ? 'Spiel (Losesitz)' :
      'Übergang';

    const badgeClass = type.includes('Spiel') ? '' : (type.includes('Übermaß') ? 'err' : '');

    fitOut.innerHTML = `
      <div class="i-grid">
        <div>
          <label>Loch ${H}</label>
          <div>Min: <b>${fmt(holeMin)}</b> mm</div>
          <div>Max: <b>${fmt(holeMax)}</b> mm</div>
        </div>
        <div>
          <label>Welle ${S}</label>
          <div>Min: <b>${fmt(shaftMin)}</b> mm</div>
          <div>Max: <b>${fmt(shaftMax)}</b> mm</div>
        </div>
        <div class="full">
          <label>Sitz</label>
          <div>Typ: <span class="badge ${badgeClass}">${type}</span></div>
          <div>Spiel/Nat.: <b>${fmt(clearanceMin)}</b> … <b>${fmt(clearanceMax)}</b> mm</div>
        </div>
      </div>
      <div class="row mt">
        <button class="btn brand" id="fitSave">Als Notiz speichern</button>
      </div>
    `;

    document.getElementById('fitSave').onclick = ()=>{
      const body = [
        \`Ø Nenn: \${fmt(D)} mm\`,
        \`Loch: \${H}  → [\${fmt(holeMin)} ; \${fmt(holeMax)}] mm\`,
        \`Welle: \${S} → [\${fmt(shaftMin)} ; \${fmt(shaftMax)}] mm\`,
        \`Sitz: \${type}, Δ = [\${fmt(clearanceMin)} ; \${fmt(clearanceMax)}] mm\`
      ].join('\\n');
      const docs = CT.storage.read(CT_KEYS.DOCS, []);
      docs.push({id:CT.uid(), title:\`Passmaß \${H}/\${S} Ø\${fmt(D)}\`, category:'Passung', tags:['iso','fit'], body});
      CT.storage.write(CT_KEYS.DOCS, docs); CT.toast('Notiz gespeichert','ok');
    };
  }

  fitCalc.onclick = calcFit;
  fitPreset.onclick = ()=>{
    const v=(fitFast.value||'').replace(/\s+/g,'').toUpperCase();
    const m = v.match(/^(H7)\/(H6|H7|[A-Z]6|[A-Z]7|[A-Z][0-9])$|^(H7)\/([GP]6|H6|G6|P6)$/i);
    // Просто парсим H7/<shaft>
    const parts = (fitFast.value||'').split('/');
    if(parts.length===2){
      const hole=parts[0].trim().toUpperCase();
      const shaft=parts[1].trim();
      if(hole==='H7'){ fitHole.value='H7'; }
      if(['h6','g6','p6'].includes(shaft.toLowerCase())) fitShaft.value=shaft.toLowerCase();
    }
    calcFit();
  };

  // init outputs
  calcMat();
  renderChamfer();
  calcFit();
});
</script>
</body>
</html>