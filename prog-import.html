<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>CitiTool • Programm-Import</title>
<link rel="stylesheet" href="./ui/core.css">
<style>
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .codearea{width:100%;min-height:220px;border-radius:12px;border:1px solid #dae2f3;padding:10px}
  .hidden{display:none}
  .pill{display:inline-block;padding:2px 8px;border-radius:10px;background:#eef3ff;color:var(--brand);font-weight:700}
  .muted-sm{font-size:12px;color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  @media (max-width:520px){.grid2{grid-template-columns:1fr}}
  .tool-row{display:grid;grid-template-columns:56px 1fr auto;gap:.6rem;align-items:center;border:1px solid #e5ebf7;border-radius:14px;padding:8px;background:#fff}
  .thumb{width:56px;height:56px;border-radius:10px;background:#f0f3fa;display:grid;place-items:center;color:#9cb1d9;font-weight:800}
  .stat{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
  @media (max-width:600px){.stat{grid-template-columns:1fr 1fr}}
  .stat .card{padding:12px}
  .kvs{display:grid;grid-template-columns:auto 1fr;gap:4px 8px;align-items:start}
  .kvs b{font-variant-numeric:tabular-nums}
  .cmp-grid{display:grid;grid-template-columns:40px 1fr 1fr;gap:6px;align-items:center}
  .cmp-grid .badge{min-width:auto}
  .cmp-ok{background:#eaf8f0;color:#147c46}
  .cmp-miss{background:#fff3f3;color:#b3261e}
  .cmp-diff{background:#fff7e5;color:#8a6400}
  /* Werkzeugliste */
  .print-wrap{background:#fff;border:1px solid #e7eef9;border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .wl-head{display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin:0 0 12px}
  .wl-head h3{margin:0;font-size:20px}
  .wl-title{font-size:14px;color:var(--muted)}
  .wl-progline[contenteditable="true"]{display:inline-block;border:1px dashed #dfe6f7;border-radius:8px;padding:4px 8px;min-width:160px}
  .wl-progline:focus{outline:none;border-color:#c9d8fb;background:#f8fbff}
  .wl-table{width:100%;border-collapse:separate;border-spacing:0}
  .wl-table th,.wl-table td{padding:12px;border-top:1px solid #eef3ff}
  .wl-table thead th{font-size:12px;text-transform:uppercase;letter-spacing:.03em;color:#5b6b86;border-top:0}
  .wl-table tbody tr:nth-child(odd){background:#fafcff}
  .wl-table .nr{white-space:nowrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .wl-remark{min-height:32px;border:1px dashed #dfe6f7;border-radius:8px;padding:6px}
  .no-print{}

  /* print */
  @media print{
    header.appbar, .dock, .section:first-of-type, .tabs, .no-print{display:none!important}
    body{background:#fff}
    .print-wrap{box-shadow:none;border:0;border-radius:0;padding:0}
    .wl-head h3{font-size:18pt}
    .wl-title{font-size:12pt}
    .wl-progline{border:0;padding:0}
    .wl-table th,.wl-table td{border:1px solid #ccc;padding:8px}
    .wl-table thead th{text-transform:none;color:#000;border:1px solid #ccc}
    .wl-table tbody tr:nth-child(odd){background:#fff}
    .wl-remark{border:1px solid #bbb;min-height:24px}
  }
</style>
</head>
<body data-active="tools">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Programm-Import</div></div>
    </a>
    <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
      <svg><use href="./ui/icons.svg#search"/></svg>
    </button>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Suchen…" id="s"></div>

<main class="container">
  <!-- Ввод программы -->
  <section class="section">
    <h2>G-Code</h2>
    <div class="row">
      <input id="file" type="file" accept=".txt,.nc,.tap,.gcode,.iso">
      <button class="btn" id="fromClip">Aus Zwischenablage</button>
    </div>
    <textarea id="code" class="codearea mono" spellcheck="false" placeholder="Füge hier dein Programm ein…"></textarea>
    <div class="row mt">
      <button class="btn brand" id="parse">Parsen</button>
      <button class="btn" id="clear">Leeren</button>
    </div>
    <div class="muted" style="margin-top:.4rem">
      Beispiele: <code class="mono">O1809(PK234185RO)</code> → Nr=<b>234185</b>, Seite=<b>RO</b>.  
      Für jedes <code>Tnnnn</code> берётся первый Kommentar <b>после</b> этого T (до следующего T).
    </div>
  </section>

  <!-- Результаты -->
  <section class="section hidden" id="res">
    <div class="tabs">
      <button class="tab active" data-tab="an">Analyse</button>
      <button class="tab" data-tab="tw">Werkzeuge</button>
      <button class="tab" data-tab="su">Setup</button>
      <button class="tab" data-tab="wl">Werkzeugliste</button>
      <button class="tab" data-tab="hi">Historie</button>
    </div>

    <!-- Analyse -->
    <div id="tab-an">
      <div class="grid2">
        <label class="fld">Programm-Titel<input id="pTitle" placeholder="—"></label>
        <label class="fld">Programm-Nr.<input id="pNum" placeholder="—"></label>
        <label class="fld">Koordinatensystem<input id="pWCS" readonly></label>
        <label class="fld">Status<input id="pStatus" value="Entwurf" readonly></label>
      </div>
      <div class="stat mt">
        <div class="card"><div class="muted-sm">Tools</div><div style="font-size:24px;font-weight:800" id="stTools">0</div></div>
        <div class="card"><div class="muted-sm">Kommentare</div><div style="font-size:24px;font-weight:800" id="stCom">0</div></div>
        <div class="card"><div class="muted-sm">M1 Pausen</div><div style="font-size:24px;font-weight:800" id="stM1">0</div></div>
      </div>
      <div class="section mt">
        <h2>G/M Übersicht</h2>
        <div class="kvs" id="gmList"></div>
      </div>
      <div class="row mt">
        <label class="chk"><input type="checkbox" id="assignLive" checked> Auch ins Live-Setup einfügen</label>
        <button class="btn brand" id="createDraft">Als Programm anlegen (Entwurf)</button>
        <button class="btn" id="openSetup">In Setup öffnen</button>
        <button class="btn" id="addAll">Fehlende Tools → hinzufügen</button>
      </div>
    </div>

    <!-- Werkzeuge -->
    <div id="tab-tw" class="hidden"><div id="list"></div></div>

    <!-- Setup (Vergleich & Anwenden) -->
    <div id="tab-su" class="hidden">
      <div class="row">
        <div class="pill" id="suSide">Side: —</div>
        <button class="btn" id="btnCompare">Live vergleichen</button>
        <button class="btn ok" id="btnApply">Setup aktualisieren</button>
      </div>
      <div class="cmp-grid mt" id="cmpGrid">
        <!-- rows: slot | import T | live state -->
      </div>
    </div>

    <!-- Werkzeugliste -->
    <div id="tab-wl" class="hidden">
      <div class="print-wrap">
        <div class="wl-head">
          <h3>Werkzeugliste</h3>
          <div class="wl-title">Programm:&nbsp;<span id="pl-progline" class="wl-progline" contenteditable="true">—</span></div>
        </div>
        <table class="wl-table" id="pl-table">
          <thead>
            <tr><th style="width:88px">Nr.</th><th>Werkzeug</th><th style="width:220px">Bemerkungen</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row mt no-print">
        <button class="btn" id="btnSaveDoc">Als Notiz speichern</button>
        <button class="btn" id="btnCSV">CSV exportieren</button>
        <button class="btn" id="btnPrint">Drucken / PDF</button>
      </div>
    </div>

    <!-- Historie -->
    <div id="tab-hi" class="hidden">
      <ul id="hist" class="cards"></ul>
      <div class="row mt">
        <button class="btn warn" id="histClear">Historie löschen</button>
      </div>
    </div>

  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();
  const LOG_KEY = 'ct_import_log_v1';

  // ---------- helpers ----------
  const readFileAsText = f => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result||''); r.onerror=rej; r.readAsText(f); });

  function parseOLine(src){
    const m = src.match(/^\s*O(\d+)\s*\(([^)]*)\)/mi);
    if(!m) return { num:null, comment:null, side:null, raw:null };
    const comment = (m[2]||'').trim();
    const side = /RU\b/i.test(comment) ? 'RU' : (/RO\b/i.test(comment) ? 'RO' : null);
    const extNum = (comment.match(/(\d{5,})/)||[])[1] || null;
    return { num: extNum, comment, side, raw: m[0] };
  }
  function detectWCS(txt, sideHint){
    if(sideHint==='RO') return { text:'RO (G54)', raw:'G54', short:'RO' };
    if(sideHint==='RU') return { text:'RU (G55)', raw:'G55', short:'RU' };
    const m = txt.match(/\bG5([45])\b/i);
    if(!m) return { text:'—', raw:'', short:'' };
    return m[1]==='4' ? { text:'RO (G54)', raw:'G54', short:'RO' } : { text:'RU (G55)', raw:'G55', short:'RU' };
  }
  function parseToolsWithIndices(txt){
    const out=[]; const seen=new Set(); let m;
    const rePair=/T\s*([0-9]{2})[\s,.;:_-]*([0-9]{2})/ig;
    while((m=rePair.exec(txt))!==null){ const pos=+m[1]; if(pos>=1&&pos<=12&&!seen.has(pos)){ seen.add(pos); out.push({t:`T${m[1]}${m[2]}`,pos,off:m[2],index:m.index}); } }
    const re4=/T\s*([0-9]{4})/ig;
    while((m=re4.exec(txt))!==null){ const d=m[1],pos=+d.slice(0,2); if(pos>=1&&pos<=12&&!seen.has(pos)){ seen.add(pos); out.push({t:`T${d}`,pos,off:d.slice(2),index:m.index}); } }
    const re2=/T\s*([0-9]{2})(?!\s*[0-9])/ig;
    while((m=re2.exec(txt))!==null){ const pos=+m[1]; if(pos>=1&&pos<=12&&!seen.has(pos)){ seen.add(pos); out.push({t:`T${m[1]}`,pos,off:'',index:m.index}); } }
    out.sort((a,b)=>a.index-b.index); return out;
  }
  function collectComments(txt){ const res=[]; const re=/\(([^)]+)\)/g; let m; while((m=re.exec(txt))!==null){ res.push({text:(m[1]||'').trim(),index:m.index}); } return res; }
  function nearestComment(comments, startIdx, nextIdx){ for(const c of comments){ if(c.index>startIdx && (nextIdx==null || c.index<nextIdx)) return c.text; } return ''; }
  function countCodes(txt, prefix){ const re=new RegExp('\\b'+prefix+'(\\d+)\\b','ig'); const map={}; let m; while((m=re.exec(txt))!==null){ const k=prefix+m[1]; map[k]=(map[k]||0)+1; } return map; }

  function buildParsed(txt){
    const O=parseOLine(txt);
    const wcs=detectWCS(txt,O.side);
    const tools=parseToolsWithIndices(txt);
    const comments=collectComments(txt);
    let progTitle='';
    if(O.comment){ progTitle=O.comment.replace(/\b(RO|RU)\b/i,'').replace(/\d{5,}/,'').replace(/[_\-\.]+/g,' ').trim(); }
    if(!progTitle && comments[0]) progTitle=comments[0].text;
    for(let i=0;i<tools.length;i++){
      const start=tools[i].index, end=(i<tools.length-1)?tools[i+1].index:null;
      tools[i].titleBase = nearestComment(comments,start,end) || progTitle || '';
    }
    const G=countCodes(txt,'G'), M=countCodes(txt,'M');
    const m1=(M['M1']||0);
    return { number:O.num||'', title:progTitle, wcsText:wcs.text, wcsRaw:wcs.raw, wcsShort:wcs.short, tools, comments, G, M, m1 };
  }

  // ---------- render: Analyse ----------
  function renderAnalyse(p){
    pTitle.value = p.title||'';
    pNum.value   = p.number||'';
    pWCS.value   = p.wcsText||'—';
    pStatus.value= 'Entwurf';

    stTools.textContent = p.tools.length;
    stCom.textContent   = p.comments.length;
    stM1.textContent    = p.m1;

    const gm = document.getElementById('gmList'); gm.innerHTML='';
    const toList = (obj, lbl) => {
      const keys=Object.keys(obj).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
      if(keys.length===0) return '';
      return `<div style="grid-column:1/-1"><b>${lbl}</b></div>` +
             keys.map(k=>`<div>${k}</div><b>${obj[k]}</b>`).join('');
    };
    gm.innerHTML = toList(p.G,'G-Codes') + toList(p.M,'M-Codes');
  }

  // ---------- render: Werkzeuge ----------
  function findExistingToolByCode(code){
    const tools=CT.storage.read(CT_KEYS.TOOLS,[]);
    return tools.find(t => (t.code||'').toLowerCase()===(code||'').toLowerCase());
  }
  function renderToolsTab(parsed){
    const cats=CT.storage.read(CT_KEYS.CATS,[]); const defCat=cats[0]?.id;
    const root=document.getElementById('list'); root.innerHTML='';
    if(!parsed.tools.length){ root.innerHTML='<div class="muted">Keine Tools gefunden</div>'; return; }
    parsed.tools.forEach((row,i)=>{
      const nameDef=(row.titleBase||parsed.title||'Werkzeug')+' • '+row.t;
      const catOptions=cats.map(c=>`<option value="${c.id}" ${c.id===defCat?'selected':''}>${CT.escape(c.title)}</option>`).join('');
      const exists=findExistingToolByCode(row.t);
      const el=document.createElement('div'); el.className='tool-row';
      el.innerHTML=`
        <div class="thumb">No</div>
        <div class="meta">
          <div class="name">
            <input class="field" id="nm_${i}" value="${CT.escape(nameDef)}">
            ${exists?'<span class="pill">exis.</span>':''}
          </div>
          <div class="muted-sm">Slot: <b>${row.pos}</b> • Code: <b>${CT.escape(row.t)}</b></div>
          <div class="row mt">
            <label class="fld" style="flex:1;min-width:140px">Kategorie
              <select id="cat_${i}">${catOptions}</select>
            </label>
            <label class="fld" style="flex:1;min-width:140px">ISO
              <input id="iso_${i}" placeholder="optional">
            </label>
          </div>
        </div>
        <div><button class="btn ${exists?'':'brand'}" data-idx="${i}">${exists?'Verknüpfen':'Übernehmen'}</button></div>`;
      el.querySelector('button').onclick=()=>addOneTool(i,parsed);
      root.appendChild(el);
    });
  }
  function addOneTool(i, parsed){
    const t = parsed.tools[i];
    const name = document.getElementById('nm_'+i).value || (t.titleBase||parsed.title||'Werkzeug')+' • '+t.t;
    const catId= document.getElementById('cat_'+i).value;
    const iso  = document.getElementById('iso_'+i).value;

    let tool = findExistingToolByCode(t.t);
    if(!tool){
      const tools = CT.storage.read(CT_KEYS.TOOLS, []);
      tool = { id:CT.uid(), name, code:t.t, catId, iso, maker:'', note:(t.titleBase||parsed.title||''), imgData:'', lifePct:100 };
      tools.push(tool);
      CT.storage.write(CT_KEYS.TOOLS, tools);
    }
    if(assignLive.checked){
      const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
      const side = parsed.wcsRaw==='G54' ? 'ro' : (parsed.wcsRaw==='G55' ? 'ru' : null);
      if(side){
        const idx = Math.max(1, Math.min(12, t.pos)) - 1;
        if(!live[side][idx]){
          live[side][idx] = { toolId: tool.id, note:'' };
          CT.storage.write(CT_KEYS.SETUP, live);
        }
      }
    }
    CT.toast('OK','ok');
  }

  // ---------- render: Setup Vergleich ----------
  function renderSetupTab(parsed){
    suSide.textContent = 'Side: ' + (parsed.wcsShort||'—');
    const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
    const tools = CT.storage.read(CT_KEYS.TOOLS, []);
    const side = parsed.wcsRaw==='G55' ? 'ru' : 'ro';
    const plan = Array(12).fill(null);
    parsed.tools.forEach(t=>{ const s=Math.max(1,Math.min(12,t.pos))-1; plan[s]=t; });

    const grid=document.getElementById('cmpGrid'); grid.innerHTML='';
    for(let i=0;i<12;i++){
      const imp = plan[i]?.t || '—';
      const liveCell = live[side][i];
      const liveTool = liveCell ? tools.find(x=>x.id===liveCell.toolId) : null;
      const liveCode = liveTool?.code || '—';
      let cls='cmp-miss', lab='leer';
      if(imp==='—' && liveCode==='—'){ cls=''; lab='—'; }
      else if(imp!=='—' && liveCode==='—'){ cls='cmp-miss'; lab='fehlt'; }
      else if(imp===liveCode){ cls='cmp-ok'; lab='ok'; }
      else { cls='cmp-diff'; lab='anders'; }
      const row=document.createElement('div'); row.className='row' ;
      row.innerHTML = `
        <span class="badge">#${i+1}</span>
        <div class="card" style="flex:1"><div class="muted-sm">Import</div><b>${CT.escape(imp)}</b></div>
        <div class="card ${cls}" style="flex:1"><div class="muted-sm">Live</div><b>${CT.escape(liveCode)}</b> <span class="pill" style="margin-left:6px">${lab}</span></div>
      `;
      grid.appendChild(row);
    }
  }
  function applySetupFromParsed(parsed){
    const side = parsed.wcsRaw==='G55' ? 'ru' : 'ro';
    const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
    const tools = CT.storage.read(CT_KEYS.TOOLS, []);
    parsed.tools.forEach(t=>{
      const idx=Math.max(1,Math.min(12,t.pos))-1;
      const found = tools.find(x => (x.code||'').toLowerCase() === t.t.toLowerCase());
      if(found) live[side][idx]={toolId:found.id, note:''};
    });
    CT.storage.write(CT_KEYS.SETUP, live);
    CT.toast('Live aktualisiert','ok');
    renderSetupTab(parsed);
  }

  // ---------- render: Werkzeugliste ----------
  function renderListTab(parsed){
    const progLine = (parsed.number ? parsed.number : '—') + (parsed.wcsShort ? '.'+parsed.wcsShort : '');
    pl_progline.textContent = progLine;
    const tbody=document.querySelector('#pl-table tbody'); tbody.innerHTML='';
    parsed.tools.forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nr" contenteditable="true">${CT.escape(t.t)}</td>
        <td class="wname" contenteditable="true">${CT.escape(t.titleBase||parsed.title||'—')}</td>
        <td><div class="wl-remark" contenteditable="true"></div></td>`;
      tbody.appendChild(tr);
    });
  }
  function saveListToDocs(){
    const prog = pl_progline.textContent.trim() || 'Werkzeugliste';
    const rows = Array.from(document.querySelectorAll('#pl-table tbody tr')).map(tr=>{
      const t = tr.querySelector('.nr').textContent.trim();
      const n = tr.querySelector('.wname').textContent.trim();
      const r = tr.querySelector('.wl-remark').textContent.trim();
      return {t,n,r};
    });
    const body = rows.map(r=>`${r.t} — ${r.n}${r.r?` — ${r.r}`:''}`).join('\n');
    const docs = CT.storage.read(CT_KEYS.DOCS, []);
    docs.push({id:CT.uid(), title:`Werkzeugliste ${prog}`, category:'Programme', tags:['liste'], body, favorite:false});
    CT.storage.write(CT_KEYS.DOCS, docs);
    CT.toast('In Docs gespeichert','ok');
  }
  function exportCSV(){
    const prog = pl_progline.textContent.trim() || 'Werkzeugliste';
    const rows = Array.from(document.querySelectorAll('#pl-table tbody tr')).map(tr=>{
      const t = tr.querySelector('.nr').textContent.replace(/"/g,'""');
      const n = tr.querySelector('.wname').textContent.replace(/"/g,'""');
      const r = tr.querySelector('.wl-remark').textContent.replace(/"/g,'""');
      return `"${t}","${n}","${r}"`;
    });
    const csv = `Nr,Werkzeug,Bemerkungen\n` + rows.join('\n');
    CT.exportJSON(`${prog}.csv`, csv); // маленький трюк: экспорт тем же helper (MIME не критичен в Safari)
  }

  // ---------- render: Historie ----------
  function pushHistory(parsed){
    const log = CT.storage.read(LOG_KEY, []);
    log.unshift({id:CT.uid(), time:Date.now(), num:parsed.number||'—', side:parsed.wcsShort||'—', tools:parsed.tools.length, title:parsed.title||''});
    CT.storage.write(LOG_KEY, log.slice(0,50));
  }
  function renderHistory(){
    const list = CT.storage.read(LOG_KEY, []);
    const ul=document.getElementById('hist'); ul.innerHTML='';
    if(!list.length){ ul.innerHTML = '<li class="muted">Keine Einträge</li>'; return; }
    list.forEach(it=>{
      const li=document.createElement('li'); li.className='card';
      li.innerHTML = `<b>#${CT.escape(it.num)}.${CT.escape(it.side)}</b><div class="muted-sm">${new Date(it.time).toLocaleString()} • Tools: ${it.tools}</div><div>${CT.escape(it.title)}</div>`;
      ul.appendChild(li);
    });
  }

  // ---------- Draft Programm ----------
  function createDraftProgram(parsed){
    const progs = CT.storage.read(CT_KEYS.PROGS, []);
    const number = (pNum.value || parsed.number || '').trim();
    const title  = (pTitle.value || parsed.title || 'Programm').trim();
    if(!number){ CT.toast('Programm-Nr. fehlt','err'); return; }
    const ro = Array(12).fill(null), ru = Array(12).fill(null);
    const side = parsed.wcsRaw==='G55' ? 'ru' : 'ro';
    const tools = CT.storage.read(CT_KEYS.TOOLS, []);
    parsed.tools.forEach(t=>{
      const slot = Math.max(1, Math.min(12, t.pos)) - 1;
      const found = tools.find(x => (x.code||'').toLowerCase() === t.t.toLowerCase());
      const cell = found ? { toolId:found.id, note:'' } : { toolId:null, note:'' };
      if(side==='ro' && !ro[slot]) ro[slot]=cell;
      if(side==='ru' && !ru[slot]) ru[slot]=cell;
    });
    const draft = { id:CT.uid(), number, title, date:Date.now(), status:'draft', ro, ru, drawing:null };
    progs.push(draft);
    CT.storage.write(CT_KEYS.PROGS, progs);
    CT.toast(`Programm #${number} als Entwurf angelegt`, 'ok');
  }

  // ---------- UI wiring ----------
  function showTab(key){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
    ['an','tw','su','wl','hi'].forEach(k=>document.getElementById('tab-'+k).classList.toggle('hidden', k!==key));
  }

  // input
  file.onchange = async ()=>{ const f=file.files?.[0]; if(!f) return; code.value = await readFileAsText(f); };
  fromClip.onclick = async ()=>{ try{ code.value = await navigator.clipboard.readText(); CT.toast('Eingefügt','ok'); }catch{ CT.toast('Clipboard nicht verfügbar','err'); } };
  clear.onclick = ()=>{ code.value=''; res.classList.add('hidden'); };

  parse.onclick = ()=>{
    const txt = code.value||''; if(!txt.trim()) return CT.toast('Kein Text','err');
    const p = buildParsed(txt);
    res.classList.remove('hidden');
    renderAnalyse(p);
    renderToolsTab(p);
    renderSetupTab(p);
    renderListTab(p);
    res._parsed = p;
    pushHistory(p);
    renderHistory();
  };

  // buttons
  document.getElementById('addAll').onclick    = ()=>{ const p=res._parsed; if(!p) return; p.tools.forEach((_,i)=>addOneTool(i,p)); CT.toast('Tools übernommen','ok'); };
  document.getElementById('createDraft').onclick= ()=>{ const p=res._parsed; if(!p) return; createDraftProgram(p); };
  document.getElementById('openSetup').onclick  = ()=>{ location.href='./setup.html'; };

  document.getElementById('btnCompare').onclick = ()=>{ const p=res._parsed; if(!p) return; renderSetupTab(p); CT.toast('Verglichen','ok'); };
  document.getElementById('btnApply').onclick   = ()=>{ const p=res._parsed; if(!p) return; applySetupFromParsed(p); };

  document.getElementById('btnPrint').onclick   = ()=>{ window.print(); };
  document.getElementById('btnSaveDoc').onclick = ()=>saveListToDocs();
  document.getElementById('btnCSV').onclick     = ()=>exportCSV();

  document.getElementById('histClear').onclick  = ()=>{ CT.storage.write(LOG_KEY, []); renderHistory(); CT.toast('Historie gelöscht','ok'); };

  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));

  // start with Analyse
  showTab('an'); renderHistory();
});
</script>
</body>
</html>