<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CitiTool • Programm-Import</title>
  <link rel="stylesheet" href="./ui/core.css">
  <style>
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .codearea{width:100%;min-height:220px;border-radius:12px;border:1px solid #dae2f3;padding:10px}
    .findings{display:grid;gap:.5rem}
    .tool-row{display:grid;grid-template-columns:56px 1fr auto;gap:.6rem;align-items:center;border:1px solid #e5ebf7;border-radius:14px;padding:8px;background:#fff}
    .thumb{width:56px;height:56px;border-radius:10px;background:#f0f3fa;display:grid;place-items:center;color:#9cb1d9;font-weight:800}
    .muted-sm{font-size:12px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body data-active="tools">
<header class="appbar">
  <div class="wrap">
    <a class="logo" href="./index.html">
      <span class="ct-badge" aria-hidden="true">CT</span>
      <div class="tit"><div class="title">CitiTool</div><div class="subtitle">Programm-Import</div></div>
    </a>
    <button class="icon-btn" data-ct="search-toggle" aria-label="Suchen">
      <svg><use href="./ui/icons.svg#search"/></svg>
    </button>
  </div>
</header>
<div class="searchbar collapsed"><input class="field" type="search" placeholder="Suchen…" id="s"></div>

<main class="container">
  <section class="section">
    <h2>G-Code</h2>
    <div class="row">
      <input id="file" type="file" accept=".txt,.nc,.tap,.gcode,.iso">
      <button class="btn" id="fromClip">Aus Zwischenablage</button>
    </div>
    <textarea id="code" class="codearea mono" spellcheck="false" placeholder="Füge hier dein Programm ein…"></textarea>
    <div class="row mt">
      <button class="btn brand" id="parse">Parsen</button>
      <button class="btn" id="clear">Leeren</button>
    </div>
  </section>

  <section class="section" id="res" style="display:none">
    <h2>Erkannte Daten</h2>
    <div class="grid2">
      <label class="fld">Titel<input id="pTitle" placeholder="—"></label>
      <label class="fld">Koordinatensystem<input id="pWCS" readonly></label>
    </div>
    <label class="chk mt"><input type="checkbox" id="assignLive" checked> Auch ins Live-Setup einfügen</label>

    <h3 style="margin:12px 2px 8px">Tools (Tnnnn)</h3>
    <div id="list" class="findings"></div>
  </section>
</main>

<nav class="dock" id="dock"></nav>

<script src="./ui/core.js"></script>
<script src="./ui/dock.js"></script>
<script>
CT.ready(()=>{
  CT.ensureSeeds();
  const NOIMG = '<div class="thumb">No</div>';

  const readFileAsText = f => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result||''); r.onerror=rej; r.readAsText(f); });

  function firstComment(txt){
    // первый комментарий в круглых скобках
    return (txt.match(/\(([^)]+)\)/) || [,''])[1]?.trim() || '';
  }
  function detectWCS(txt){
    const m = txt.match(/\bG5([45])\b/i);
    if(!m) return { text:'—', raw:'' };
    return m[1]==='4' ? { text:'RO (G54)', raw:'G54' } : { text:'RU (G55)', raw:'G55' };
  }

  // РОБАСТНЫЙ ПАРСЕР T-кодов:
  // поддерживает: "T0202", "T 0202", "T02 02", "T0202;", "t0202"
  // а также "T02" (только номер слота) как запасной вариант
  function parseTools(txt){
    const out = [];
    const seen = new Set();

    // 1) T + 2 и 2 цифры с пробелами/без
    const rePair = /\bT\s*([0-9]{2})\s*([0-9]{2})\b/ig;
    let m;
    while((m = rePair.exec(txt)) !== null){
      const pos = parseInt(m[1],10);
      const off = m[2];
      if(pos>=1 && pos<=12 && !seen.has(pos)){
        seen.add(pos); out.push({ t:`T${m[1]}${m[2]}`, pos, off });
      }
    }

    // 2) T + 4 цифры подряд
    const re4 = /\bT\s*([0-9]{4})\b/ig;
    while((m = re4.exec(txt)) !== null){
      const digits = m[1];
      const pos = parseInt(digits.slice(0,2),10);
      const off = digits.slice(2);
      if(pos>=1 && pos<=12 && !seen.has(pos)){
        seen.add(pos); out.push({ t:`T${digits}`, pos, off });
      }
    }

    // 3) запасной вариант: T + 2 цифры (не за которым сразу идут ещё цифры)
    const re2 = /\bT\s*([0-9]{2})(?!\s*[0-9])/ig;
    while((m = re2.exec(txt)) !== null){
      const pos = parseInt(m[1],10);
      if(pos>=1 && pos<=12 && !seen.has(pos)){
        seen.add(pos); out.push({ t:`T${m[1]}`, pos, off:'' });
      }
    }

    return out;
  }

  function render(parsed){
    res.style.display = '';
    pTitle.value = parsed.title || '';
    pWCS.value   = parsed.wcs.text;

    const cats = CT.storage.read(CT_KEYS.CATS, []);
    const defCat = cats[0]?.id;
    list.innerHTML = '';

    if(!parsed.tools.length){
      list.innerHTML = '<div class="muted">Keine Tools gefunden</div>';
      return;
    }

    parsed.tools.forEach((row,i)=>{
      const nameDef = (parsed.title || 'Werkzeug') + ' • ' + row.t;
      const catOptions = cats.map(c=>`<option value="${c.id}" ${c.id===defCat?'selected':''}>${CT.escape(c.title)}</option>`).join('');
      const el = document.createElement('div'); el.className='tool-row';
      el.innerHTML = `
        ${NOIMG}
        <div class="meta">
          <div class="name"><input class="field" id="nm_${i}" value="${CT.escape(nameDef)}"></div>
          <div class="muted-sm">Slot: <b>${row.pos}</b> • Code: <b>${CT.escape(row.t)}</b></div>
          <div class="row mt">
            <label class="fld" style="flex:1;min-width:140px">Kategorie
              <select id="cat_${i}">${catOptions}</select>
            </label>
            <label class="fld" style="flex:1;min-width:140px">ISO
              <input id="iso_${i}" placeholder="optional">
            </label>
          </div>
        </div>
        <div><button class="btn brand" data-idx="${i}">Übernehmen</button></div>`;
      el.querySelector('button').onclick = ()=> addOne(i, parsed);
      list.appendChild(el);
    });
  }

  function addOne(i, parsed){
    const t = parsed.tools[i];
    const name = document.getElementById('nm_'+i).value || (parsed.title||'Werkzeug')+' • '+t.t;
    const catId = document.getElementById('cat_'+i).value;
    const iso = document.getElementById('iso_'+i).value;

    // создаём в TOOLS
    const tools = CT.storage.read(CT_KEYS.TOOLS, []);
    const tool = { id:CT.uid(), name, code:t.t, catId, iso, maker:'', note:(parsed.title||''), imgData:'', lifePct:100 };
    tools.push(tool);
    CT.storage.write(CT_KEYS.TOOLS, tools);

    // при необходимости — сразу в Live Setup
    if(assignLive.checked){
      const live = CT.storage.read(CT_KEYS.SETUP, { ro:Array(12).fill(null), ru:Array(12).fill(null) });
      const side = parsed.wcs.raw==='G54' ? 'ro' : (parsed.wcs.raw==='G55' ? 'ru' : null);
      if(side){
        const idx = Math.max(1, Math.min(12, t.pos)) - 1;
        if(!live[side][idx]){ // не перезаписываем занятый
          live[side][idx] = { toolId: tool.id, note:'' };
          CT.storage.write(CT_KEYS.SETUP, live);
        }
      }
    }
    CT.toast('Hinzugefügt','ok');
  }

  // UI
  file.onchange = async ()=>{
    const f = file.files?.[0]; if(!f) return;
    code.value = await readFileAsText(f);
  };
  fromClip.onclick = async ()=>{
    try{ code.value = await navigator.clipboard.readText(); CT.toast('Eingefügt','ok'); }
    catch{ CT.toast('Clipboard nicht verfügbar','err'); }
  };
  clear.onclick = ()=>{ code.value=''; res.style.display='none'; };

  parse.onclick = ()=>{
    const txt = code.value||''; if(!txt.trim()) return CT.toast('Kein Text','err');

    const title = firstComment(txt) || '';
    const wcs = detectWCS(txt);
    const tools = parseTools(txt);

    render({ title, wcs, tools });
  };
});
</script>
</body>
</html>